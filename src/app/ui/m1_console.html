<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TheWorld 本体管理台 | Ontology IDE</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" />
    <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" disabled />
    <style>
        [v-cloak] { display: none; }
        .md-content h1 { font-size: 1.25rem; font-weight: bold; margin-top: 0.5rem; }
        .md-content h2 { font-size: 1.1rem; font-weight: bold; margin-top: 0.4rem; }
        .md-content p { margin-bottom: 0.4rem; font-size: 0.9rem; }
        .md-content ul { list-style-type: disc; margin-left: 1.2rem; font-size: 0.9rem; }
        .tree-node { margin-left: 1rem; border-left: 1px solid #e5e7eb; padding-left: 0.5rem; }
        .active-item { background-color: oklch(var(--p) / 0.1); border-right: 3px solid oklch(var(--p)); }
        .app-container { height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .section-card { border: 1px solid #e2e8f0; border-radius: 0.5rem; background: white; margin-bottom: 1.5rem; }
        .section-header { padding: 0.75rem 1rem; border-bottom: 1px solid #e2e8f0; font-weight: bold; font-size: 0.875rem; color: #475569; display: flex; align-items: center; justify-content: space-between; }
        .section-body { padding: 1rem; }
        [data-theme="dark"] .tree-node { border-left-color: #334155; }
        [data-theme="dark"] ::-webkit-scrollbar-thumb { background: #475569; }
        [data-theme="dark"] .section-card { border-color: #334155; background: #0f172a; }
        [data-theme="dark"] .section-header { border-bottom-color: #334155; color: #cbd5e1; }
        [data-theme="dark"] .bg-white { background-color: #111827 !important; }
        [data-theme="dark"] .bg-slate-50 { background-color: #0f172a !important; }
        [data-theme="dark"] .bg-slate-100\/50 { background-color: rgba(30, 41, 59, 0.45) !important; }
        [data-theme="dark"] .text-gray-500 { color: #94a3b8 !important; }
        [data-theme="dark"] .text-gray-400 { color: #94a3b8 !important; }
        [data-theme="dark"] .md-content { color: #e2e8f0; }
    </style>
</head>
<body class="bg-base-100 text-base-content antialiased">
    <div id="app" v-cloak class="app-container flex flex-col">
        <!-- Top Nav / Header -->
        <header class="h-12 border-b flex items-center justify-between px-4 bg-base-100 z-30 shadow-sm shrink-0">
            <div class="flex items-center gap-4">
                <span class="font-bold text-lg flex items-center gap-2">
                    <i class="fas fa-microchip text-primary"></i> TheWorld <span class="text-xs opacity-50 font-mono">IDE</span>
                </span>
                <div class="divider divider-horizontal m-0"></div>
                <div class="flex gap-2">
                    <input v-model="config.tenantId" class="input input-xs input-bordered w-32" placeholder="Tenant ID" />
                    <input v-model="config.token" type="password" class="input input-xs input-bordered w-32" placeholder="Token" />
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button @click="toggleTheme" class="btn btn-xs btn-ghost">
                    {{ isDarkTheme ? 'Light' : 'Dark' }}
                </button>
                <button @click="openGlobalConfigModal" class="btn btn-xs btn-outline">Global Config</button>
                <button @click="openGraphWorkspace" class="btn btn-xs btn-outline">Graph</button>
                <button @click="owlValidate" class="btn btn-xs btn-outline btn-accent">Validate OWL</button>
                <button @click="owlExport" class="btn btn-xs btn-ghost text-gray-500"><i class="fas fa-download"></i></button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar Tabs -->
            <aside class="w-12 border-r bg-base-200 flex flex-col items-center py-4 gap-4 z-20 shrink-0">
                <button v-for="t in tabs" :key="t.id" @click="changeTab(t.id)" 
                    :class="['p-2 rounded-lg transition-all', activeTab === t.id ? 'bg-primary text-primary-content shadow-md' : 'hover:bg-base-300 text-gray-500']"
                    :title="t.name">
                    <i :class="['fas', t.icon]"></i>
                </button>
                <div class="mt-auto pb-4">
                    <button @click="showLogs = !showLogs" :class="['p-2 rounded-lg', showLogs ? 'text-primary' : 'text-gray-400']">
                        <i class="fas fa-terminal"></i>
                    </button>
                </div>
            </aside>

            <!-- Navigation Panel (List/Tree) -->
            <section class="w-80 border-r flex flex-col bg-base-50 overflow-hidden shrink-0">
                <div class="p-3 border-b space-y-2 shrink-0">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold opacity-70 uppercase tracking-wider">{{ currentTabName }}</span>
                        <button @click="openCreateModal()" class="btn btn-xs btn-circle btn-primary"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="relative">
                        <div class="flex gap-1">
                            <div class="relative flex-1">
                                <i class="fas fa-search absolute left-2 top-2.5 text-gray-400 text-xs"></i>
                                <input v-model="searchQuery" @keyup.enter="executeSearch" class="input input-xs input-bordered w-full pl-7" placeholder="Search..." />
                            </div>
                            <button @click="executeSearch" class="btn btn-xs btn-outline">Search</button>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-auto p-1 py-2">
                    <!-- Ontology Tree -->
                    <div v-if="activeTab === 'ontology'">
                        <div v-if="showOntologySearchResultList" class="space-y-0.5">
                            <div v-for="item in filteredOntologyList" :key="item.id"
                                @click="selectItem(item)"
                                :class="['px-3 py-2 cursor-pointer rounded flex items-center justify-between group transition-colors', selectedId === item.id ? 'active-item' : 'hover:bg-base-200']">
                                <div class="flex flex-col">
                                    <span class="text-sm font-medium">{{ item.name }}</span>
                                    <span class="text-[10px] font-mono text-gray-500">{{ item.code }}</span>
                                </div>
                            </div>
                        </div>
                        <div v-else>
                            <div v-for="node in filteredTree" :key="node.id">
                                <tree-item :node="node" :active-id="selectedId" @select="selectItem" @add-child="openCreateModal"></tree-item>
                            </div>
                        </div>
                    </div>
                    <!-- Other Lists -->
                    <div v-else class="space-y-0.5">
                        <div v-for="item in filteredList" :key="item.id" 
                            @click="selectItem(item)"
                            :class="['px-3 py-2 cursor-pointer rounded flex items-center justify-between group transition-colors', selectedId === item.id ? 'active-item' : 'hover:bg-base-200']">
                            <div class="flex flex-col">
                                <span class="text-sm font-medium">{{ item.name }}</span>
                                <span class="text-[10px] font-mono text-gray-500">{{ item.code }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Main Workspace (Detail Panel) -->
            <section class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative">
                <div v-if="selectedItem" class="flex-1 flex flex-col overflow-hidden">
                    <!-- Detail Header -->
                    <div class="h-12 border-b flex items-center justify-between px-6 bg-white shrink-0 shadow-sm z-10">
                        <div class="flex items-center gap-3">
                            <i :class="['fas', currentTabIcon, 'text-primary opacity-50']"></i>
                            <h2 class="font-bold">{{ selectedItem.name }}</h2>
                            <span class="badge badge-sm badge-ghost font-mono">#{{ selectedId }}</span>
                        </div>
                        <div class="flex gap-2">
                            <button @click="saveChanges" class="btn btn-xs btn-primary" :disabled="loading">Save Changes</button>
                            <button @click="deleteSelected" class="btn btn-xs btn-error" :disabled="loading">Delete</button>
                            <button @click="selectedItem = null; selectedId = null" class="btn btn-xs btn-ghost text-gray-400"><i class="fas fa-times"></i></button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-auto p-6">
                        <div class="max-w-4xl mx-auto space-y-4">
                            <!-- Basic Info Card -->
                            <div class="section-card">
                                <div class="section-header"><span><i class="fas fa-info-circle mr-2"></i>Basic Information</span></div>
                                <div class="section-body space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="form-control">
                                            <label class="label"><span class="label-text font-bold">Display Name</span></label>
                                            <input v-model="editForm.name" class="input input-bordered w-full" />
                                        </div>
                                        <div class="form-control">
                                            <label class="label"><span class="label-text font-bold">Code</span></label>
                                            <input :value="selectedItem.code" class="input input-bordered w-full bg-base-200" disabled />
                                        </div>
                                    </div>
                                    <div v-if="activeTab === 'data-attr'" class="form-control">
                                        <label class="label"><span class="label-text font-bold">Data Type</span></label>
                                        <select v-model="editForm.data_type" class="select select-bordered w-full">
                                            <option>string</option><option>int</option><option>date</option><option>boolean</option><option>json</option><option>array</option>
                                        </select>
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-bold">Description (Markdown)</span></label>
                                        <div class="grid grid-cols-2 gap-4">
                                            <textarea v-model="editForm.description" class="textarea textarea-bordered h-40 font-mono text-sm"></textarea>
                                            <div class="border rounded-lg p-3 bg-slate-50 overflow-auto h-40 md-content" v-html="renderMd(editForm.description)"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Skill Card -->
                            <div v-if="activeTab === 'obj-prop' || activeTab === 'capability'" class="section-card">
                                <div class="section-header"><span><i class="fas fa-brain mr-2"></i>Skill Implementation</span></div>
                                <div class="section-body space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                                        <textarea v-model="editForm.skill_md" class="textarea textarea-bordered h-40 font-mono text-sm"></textarea>
                                        <div class="border rounded-lg p-3 bg-slate-50 overflow-auto h-40 md-content" v-html="renderMd(editForm.skill_md)"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Table Binding -->
                            <div v-if="activeTab === 'ontology'" class="section-card border-l-4 border-l-primary">
                                <div class="section-header text-primary">
                                    <span><i class="fas fa-database mr-2"></i>Physical Table Mapping</span>
                                    <div class="flex items-center gap-2">
                                        <button v-if="editForm.table_name" @click="openManageDataModal" class="btn btn-xs btn-accent" :disabled="loading"><i class="fas fa-table-cells mr-1"></i>Manage Data</button>
                                        <button @click="createPhysicalTable" class="btn btn-xs btn-primary" :disabled="loading"><i class="fas fa-table mr-1"></i>Create Table</button>
                                    </div>
                                </div>
                                <div class="section-body space-y-4">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="form-control">
                                            <label class="label"><span class="label-text">Table Name</span></label>
                                            <input v-model="editForm.table_name" class="input input-bordered input-sm" placeholder="e.g. t_customer" />
                                        </div>
                                        <div class="form-control">
                                            <label class="label"><span class="label-text">Schema</span></label>
                                            <input v-model="editForm.table_schema" class="input input-bordered input-sm" placeholder="public" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bound Data Attributes -->
                            <div v-if="activeTab === 'ontology'" class="section-card">
                                <div class="section-header">
                                    <span><i class="fas fa-tags mr-2"></i>Bound Data Attributes</span>
                                    <button @click="openAttrPicker" class="btn btn-xs btn-primary"><i class="fas fa-plus mr-1"></i>添加属性</button>
                                </div>
                                <div class="section-body space-y-4">
                                    <div v-if="boundAttributesList.length === 0" class="text-center py-8 text-slate-400 text-sm italic border-2 border-dashed rounded">
                                        No attributes bound. Click "添加属性" to start.
                                    </div>
                                    <template v-else>
                                        <!-- Direct Section -->
                                        <div>
                                            <h4 class="text-[10px] font-bold opacity-40 uppercase mb-2">Direct</h4>
                                            <div class="overflow-x-auto border rounded mb-4">
                                                <table class="table table-xs w-full">
                                                    <thead class="bg-base-200">
                                                        <tr>
                                                            <th>Attribute</th>
                                                            <th>Code</th>
                                                            <th>DB Field Name</th>
                                                            <th class="w-10 text-center">Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr v-for="attr in boundAttributesList.filter(a => editForm.directAttrIds.includes(a.id))" :key="'direct-'+attr.id">
                                                            <td><button @click="openDetailPreview('data-attr', attr.id)" class="font-medium link link-hover">{{ attr.name }}</button></td>
                                                            <td class="font-mono opacity-50">{{ attr.code }}</td>
                                                            <td><input v-model="editForm.field_mappings[attr.id]" class="input input-bordered input-xs w-full" placeholder="field_name" /></td>
                                                            <td class="text-center"><button @click="removeDirectAttr(attr.id)" class="btn btn-xs btn-ghost text-error" title="移除直接绑定"><i class="fas fa-trash"></i></button></td>
                                                        </tr>
                                                        <tr v-if="boundAttributesList.filter(a => editForm.directAttrIds.includes(a.id)).length === 0">
                                                            <td colspan="4" class="text-center py-2 text-slate-300 text-xs italic">No direct attributes</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <!-- Inherited Section -->
                                        <div>
                                            <h4 class="text-[10px] font-bold opacity-40 uppercase mb-2">Inherited</h4>
                                            <div class="overflow-x-auto border rounded">
                                                <table class="table table-xs w-full">
                                                    <thead class="bg-base-200">
                                                        <tr>
                                                            <th>Attribute</th>
                                                            <th>Code</th>
                                                            <th>DB Field Name</th>
                                                            <th class="w-10 text-center">Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr v-for="attr in boundAttributesList.filter(a => !editForm.directAttrIds.includes(a.id))" :key="'inherited-'+attr.id">
                                                            <td><button @click="openDetailPreview('data-attr', attr.id)" class="font-medium link link-hover">{{ attr.name }}</button></td>
                                                            <td class="font-mono opacity-50">{{ attr.code }}</td>
                                                            <td><input v-model="editForm.field_mappings[attr.id]" class="input input-bordered input-xs w-full" placeholder="field_name" /></td>
                                                            <td class="text-center"><i class="fas fa-lock text-[10px] opacity-20" title="继承属性不可直接删除"></i></td>
                                                        </tr>
                                                        <tr v-if="boundAttributesList.filter(a => !editForm.directAttrIds.includes(a.id)).length === 0">
                                                            <td colspan="4" class="text-center py-2 text-slate-300 text-xs italic">No inherited attributes</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Object Property: Domain/Range -->
                            <div v-if="activeTab === 'obj-prop'" class="section-card">
                                <div class="section-header"><span><i class="fas fa-arrows-alt-h mr-2"></i>Domain & Range</span></div>
                                <div class="section-body grid grid-cols-2 gap-4">
                                    <div class="border rounded p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <h4 class="text-xs font-bold opacity-50 uppercase">Domain (起点)</h4>
                                            <button @click="openClassPicker('obj-domain')" class="btn btn-xs btn-primary">配置</button>
                                        </div>
                                        <div class="flex flex-wrap gap-1 min-h-6">
                                            <span v-for="cls in selectedDomainClasses" :key="'d'+cls.id" class="badge badge-outline badge-sm">{{ cls.name }}</span>
                                        </div>
                                    </div>
                                    <div class="border rounded p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <h4 class="text-xs font-bold opacity-50 uppercase">Range (终点)</h4>
                                            <button @click="openClassPicker('obj-range')" class="btn btn-xs btn-primary">配置</button>
                                        </div>
                                        <div class="flex flex-wrap gap-1 min-h-6">
                                            <span v-for="cls in selectedRangeClasses" :key="'r'+cls.id" class="badge badge-outline badge-sm">{{ cls.name }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-if="activeTab === 'capability'" class="section-card">
                                <div class="section-header">
                                    <span><i class="fas fa-layer-group mr-2"></i>Capability Domain (可触发本体)</span>
                                    <button @click="openCapabilityDomainGroupModal" class="btn btn-xs btn-primary">配置分组</button>
                                </div>
                                <div class="section-body space-y-2">
                                    <div v-if="(editForm.cap_domain_groups || []).length === 0" class="text-xs opacity-50">未配置触发域分组</div>
                                    <div v-for="(group, idx) in (editForm.cap_domain_groups || [])" :key="'cap-group-'+idx" class="border rounded p-2">
                                        <div class="text-[10px] font-bold opacity-40 uppercase mb-1">Group {{ idx + 1 }}</div>
                                        <div class="flex flex-wrap gap-1">
                                            <span v-for="classId in group" :key="'group-'+idx+'-'+classId" class="badge badge-sm badge-outline">{{ classNameById(classId) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Associated Entities -->
                            <div class="section-card bg-slate-100/50">
                                <div class="section-header"><span><i class="fas fa-project-diagram mr-2"></i>Associated Entities</span></div>
                                <div class="section-body">
                                    <div v-if="activeTab === 'ontology'" class="grid grid-cols-2 gap-6">
                                        <!-- Object Properties -->
                                        <div>
                                            <h4 class="text-[10px] font-bold opacity-40 uppercase mb-3">Object Properties</h4>
                                            <div class="space-y-3">
                                                <div>
                                                    <div class="text-[9px] font-bold opacity-30 uppercase mb-1">Direct</div>
                                                    <div class="flex flex-wrap gap-1 min-h-[1.5rem]">
                                                        <div v-for="rel in selectedItemRelations.filter(r => r.source === 'Direct')" :key="rel.id" @click="openDetailPreview('obj-prop', rel.id)" class="badge badge-outline badge-sm cursor-pointer hover:bg-primary hover:text-white">{{ rel.name }} · {{ rel.roleText.split(' · ')[0] }}</div>
                                                        <div v-if="selectedItemRelations.filter(r => r.source === 'Direct').length === 0" class="text-[10px] opacity-30 italic">None</div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="text-[9px] font-bold opacity-30 uppercase mb-1">Inherited</div>
                                                    <div class="flex flex-wrap gap-1 min-h-[1.5rem]">
                                                        <div v-for="rel in selectedItemRelations.filter(r => r.source === 'Inherited')" :key="rel.id" @click="openDetailPreview('obj-prop', rel.id)" class="badge badge-outline badge-sm cursor-pointer hover:bg-primary hover:text-white opacity-70">{{ rel.name }} · {{ rel.roleText.split(' · ')[0] }}</div>
                                                        <div v-if="selectedItemRelations.filter(r => r.source === 'Inherited').length === 0" class="text-[10px] opacity-30 italic">None</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Capabilities -->
                                        <div>
                                            <h4 class="text-[10px] font-bold opacity-40 uppercase mb-3">Capabilities</h4>
                                            <div class="space-y-3">
                                                <div>
                                                    <div class="text-[9px] font-bold opacity-30 uppercase mb-1">Direct</div>
                                                    <div class="flex flex-wrap gap-1 min-h-[1.5rem]">
                                                        <div v-for="cap in selectedItemCapabilities.filter(c => c.source === 'Direct')" :key="cap.id" @click="openDetailPreview('capability', cap.id)" class="badge badge-outline badge-sm cursor-pointer hover:bg-primary hover:text-white">{{ cap.name }} · {{ cap.roleText.split(' · ')[0] }}</div>
                                                        <div v-if="selectedItemCapabilities.filter(c => c.source === 'Direct').length === 0" class="text-[10px] opacity-30 italic">None</div>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="text-[9px] font-bold opacity-30 uppercase mb-1">Inherited</div>
                                                    <div class="flex flex-wrap gap-1 min-h-[1.5rem]">
                                                        <div v-for="cap in selectedItemCapabilities.filter(c => c.source === 'Inherited')" :key="cap.id" @click="openDetailPreview('capability', cap.id)" class="badge badge-outline badge-sm cursor-pointer hover:bg-primary hover:text-white opacity-70">{{ cap.name }} · {{ cap.roleText.split(' · ')[0] }}</div>
                                                        <div v-if="selectedItemCapabilities.filter(c => c.source === 'Inherited').length === 0" class="text-[10px] opacity-30 italic">None</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else>
                                        <h4 class="text-[10px] font-bold opacity-40 uppercase mb-2">Used by Ontologies</h4>
                                        <div class="flex flex-wrap gap-1">
                                            <div v-for="cls in boundOntologies" :key="cls.id" @click="navigateTo('ontology', cls.id)" class="badge badge-outline badge-sm cursor-pointer hover:bg-primary hover:text-white">{{ cls.name }}</div>
                                            <div v-if="boundOntologies.length === 0" class="text-[10px] opacity-30 italic">None</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else class="flex-1 flex flex-col items-center justify-center text-slate-300 bg-white">
                    <i :class="['fas', currentTabIcon, 'text-8xl mb-4 opacity-5']"></i>
                    <p class="font-medium opacity-50 uppercase tracking-widest text-sm">Select an entity to configure</p>
                </div>

                <!-- Logs Overlay -->
                <div v-if="showLogs" class="absolute bottom-0 inset-x-0 h-64 bg-slate-900 text-slate-300 font-mono text-xs overflow-auto p-4 z-40 border-t border-slate-700 shadow-2xl">
                    <div class="flex justify-between items-center sticky top-0 bg-slate-900 pb-2 mb-2 border-b border-slate-800">
                        <span class="text-blue-400"><i class="fas fa-terminal mr-2"></i> CONSOLE</span>
                        <button @click="logs = []" class="hover:text-white opacity-50">CLEAR</button>
                    </div>
                    <div v-for="(log, i) in logs" :key="i" class="mb-1">
                        <span class="opacity-30">[{{ log.time }}]</span>
                        <span :class="log.error ? 'text-rose-500' : 'text-emerald-500'" class="mx-2">{{ log.method }}</span>
                        <span class="opacity-80">{{ log.path }}</span>
                        <pre v-if="log.data" class="text-[10px] opacity-40 mt-1 ml-4">{{ JSON.stringify(log.data, null, 2) }}</pre>
                    </div>
                </div>
            </section>
        </div>

        <!-- Global Create Modal -->
        <dialog id="create_modal" class="modal">
            <div class="modal-box w-11/12 max-w-4xl p-0 overflow-hidden bg-white">
                <div class="bg-slate-800 text-white p-4 flex justify-between items-center">
                    <h3 class="font-bold flex items-center gap-2"><i class="fas fa-plus-circle text-primary"></i> Create {{ currentTabName.slice(0, -2) }}</h3>
                    <button @click="closeCreateModal" class="opacity-50 hover:opacity-100"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-8 grid grid-cols-2 gap-8 h-[65vh] overflow-y-auto">
                    <div class="space-y-4">
                        <div class="form-control"><label class="label"><span class="label-text font-bold">Code</span></label><input v-model="createForm.code" class="input input-bordered w-full font-mono" /></div>
                        <div class="form-control"><label class="label"><span class="label-text font-bold">Name</span></label><input v-model="createForm.name" class="input input-bordered w-full" /></div>
                        <div v-if="activeTab === 'ontology'" class="form-control"><label class="label"><span class="label-text font-bold">Parent (Code)</span></label><input v-model="createForm.parentCode" class="input input-bordered w-full" /></div>
                        <div v-if="activeTab === 'data-attr'" class="form-control"><label class="label"><span class="label-text font-bold">Data Type</span></label><select v-model="createForm.data_type" class="select select-bordered"><option>string</option><option>int</option><option>date</option><option>boolean</option><option>json</option><option>array</option></select></div>
                        <div class="form-control"><label class="label"><span class="label-text font-bold">Description</span></label><textarea v-model="createForm.description" class="textarea textarea-bordered h-32"></textarea></div>
                        <div v-if="activeTab === 'obj-prop' || activeTab === 'capability'" class="form-control">
                            <label class="label"><span class="label-text font-bold">Skill Markdown</span></label>
                            <textarea v-model="createForm.skill_md" class="textarea textarea-bordered h-32"></textarea>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div v-if="activeTab === 'obj-prop'" class="p-4 bg-slate-50 rounded border border-dashed space-y-3">
                            <div class="flex items-center justify-between">
                                <h4 class="text-[10px] font-bold opacity-30">Domain (起点)</h4>
                                <button @click="openClassPicker('create-obj-domain')" class="btn btn-xs btn-primary">配置</button>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                <span v-for="cid in createForm.domain_ids" :key="'create-d-'+cid" class="badge badge-outline badge-sm">{{ classNameById(cid) }}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <h4 class="text-[10px] font-bold opacity-30">Range (终点)</h4>
                                <button @click="openClassPicker('create-obj-range')" class="btn btn-xs btn-primary">配置</button>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                <span v-for="cid in createForm.range_ids" :key="'create-r-'+cid" class="badge badge-outline badge-sm">{{ classNameById(cid) }}</span>
                            </div>
                        </div>
                        <div v-if="activeTab === 'capability'" class="p-4 bg-slate-50 rounded border border-dashed space-y-3">
                            <div class="flex items-center justify-between">
                                <h4 class="text-[10px] font-bold opacity-30">Domain Groups (可触发本体)</h4>
                                <button @click="openCapabilityDomainGroupModal(true)" class="btn btn-xs btn-primary">配置分组</button>
                            </div>
                            <div v-if="(createForm.cap_domain_groups || []).length === 0" class="text-xs opacity-50">未配置</div>
                            <div v-for="(group, idx) in (createForm.cap_domain_groups || [])" :key="'create-cap-group-'+idx" class="flex flex-wrap gap-1">
                                <span class="badge badge-ghost badge-sm">G{{ idx + 1 }}</span>
                                <span v-for="cid in group" :key="'create-cap-group-'+idx+'-'+cid" class="badge badge-outline badge-sm">{{ classNameById(cid) }}</span>
                            </div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded border border-dashed">
                            <h4 class="text-[10px] font-bold opacity-30 mb-2">Description Preview</h4>
                            <div class="md-content prose prose-xs" v-html="renderMd(createForm.description)"></div>
                        </div>
                        <div v-if="activeTab === 'obj-prop' || activeTab === 'capability'" class="p-4 bg-slate-50 rounded border border-dashed">
                            <h4 class="text-[10px] font-bold opacity-30 mb-2">Skill Preview</h4>
                            <div class="md-content prose prose-xs" v-html="renderMd(createForm.skill_md)"></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 border-t flex justify-end gap-2"><button @click="closeCreateModal" class="btn btn-sm btn-ghost">Cancel</button><button @click="executeCreate" class="btn btn-sm btn-primary px-8">Create</button></div>
            </div>
        </dialog>

        <!-- Attribute Picker Modal -->
        <dialog id="attr_picker_modal" class="modal">
            <div class="modal-box w-11/12 max-w-2xl p-0 overflow-hidden bg-white">
                <div class="bg-primary text-primary-content p-4 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-list mr-2"></i>添加数据属性</h3>
                    <button @click="closeAttrPicker" class="btn btn-sm btn-ghost"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-4 space-y-4">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                        <input v-model="attrSearchQuery" class="input input-bordered w-full pl-10" placeholder="搜索属性名称或编码..." />
                    </div>
                    <div class="max-h-96 overflow-auto border rounded divide-y">
                        <label v-for="attr in filteredAllAttrs" :key="attr.id" class="flex items-center gap-3 p-3 hover:bg-slate-50 cursor-pointer">
                            <input type="checkbox" :value="attr.id" v-model="tempDirectAttrIds" class="checkbox checkbox-primary" />
                            <div class="flex-1">
                                <div class="font-medium">{{ attr.name }}</div>
                                <div class="text-xs font-mono opacity-50">{{ attr.code }} ({{ attr.data_type }})</div>
                            </div>
                            <div v-if="editForm.inheritedAttrIds.includes(attr.id)" class="badge badge-xs badge-ghost">Already Inherited</div>
                        </label>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 border-t flex justify-end gap-2">
                    <button @click="closeAttrPicker" class="btn btn-ghost">取消</button>
                    <button @click="confirmAttrPicker" class="btn btn-primary px-8">确认选择</button>
                </div>
            </div>
        </dialog>

        <!-- Class Picker Modal -->
        <dialog id="class_picker_modal" class="modal">
            <div class="modal-box w-11/12 max-w-3xl p-0 overflow-hidden bg-white">
                <div class="bg-primary text-primary-content p-4 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-sitemap mr-2"></i>{{ classPickerTitle }}</h3>
                    <button @click="closeClassPicker" class="btn btn-sm btn-ghost"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-4 max-h-[70vh] overflow-auto">
                    <div v-if="flatClassTreeWithDepth.length === 0" class="text-center py-8 text-slate-400 text-sm">暂无本体可选</div>
                    <label v-for="node in flatClassTreeWithDepth" :key="'picker-'+node.id" class="flex items-center gap-2 p-1 hover:bg-slate-50 rounded cursor-pointer">
                        <span :style="{ width: (node.depth * 16) + 'px' }"></span>
                        <input type="checkbox" :value="node.id" v-model="classPickerSelection" class="checkbox checkbox-sm" />
                        <span class="text-sm">{{ node.name }}</span>
                    </label>
                </div>
                <div class="p-4 bg-slate-50 border-t flex justify-end gap-2">
                    <button @click="closeClassPicker" class="btn btn-ghost">取消</button>
                    <button @click="confirmClassPicker" class="btn btn-primary px-8">确认</button>
                </div>
            </div>
        </dialog>

        <!-- Capability Domain Groups Modal -->
        <dialog id="cap_domain_group_modal" class="modal">
            <div class="modal-box w-11/12 max-w-4xl p-0 overflow-hidden bg-white">
                <div class="bg-primary text-primary-content p-4 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-layer-group mr-2"></i>配置 Capability Domain 分组</h3>
                    <button @click="closeCapabilityDomainGroupModal" class="btn btn-sm btn-ghost"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-4 grid grid-cols-3 gap-4 max-h-[70vh] overflow-auto">
                    <div class="border rounded p-3">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-xs font-bold uppercase opacity-50">Groups</h4>
                            <button @click="addTempCapabilityGroup" class="btn btn-xs btn-primary">新增</button>
                        </div>
                        <div class="space-y-1">
                            <button v-for="(group, idx) in tempCapDomainGroups" :key="'g-btn-'+idx" @click="activeTempGroupIndex = idx" :class="['btn btn-xs w-full justify-start', activeTempGroupIndex === idx ? 'btn-primary' : 'btn-ghost']">G{{ idx + 1 }} ({{ group.length }})</button>
                        </div>
                    </div>
                    <div class="border rounded p-3 col-span-2">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-xs font-bold uppercase opacity-50">Ontology Tree</h4>
                            <button @click="removeTempCapabilityGroup" class="btn btn-xs btn-error" :disabled="tempCapDomainGroups.length === 0">删除当前组</button>
                        </div>
                        <div v-if="tempCapDomainGroups.length === 0" class="text-center py-8 text-slate-400 text-sm">请先新增分组</div>
                        <div v-else>
                            <label v-for="node in flatClassTreeWithDepth" :key="'cap-picker-'+node.id" class="flex items-center gap-2 p-1 hover:bg-slate-50 rounded cursor-pointer">
                                <span :style="{ width: (node.depth * 16) + 'px' }"></span>
                                <input type="checkbox" :value="node.id" v-model="tempCapDomainGroups[activeTempGroupIndex]" class="checkbox checkbox-sm" />
                                <span class="text-sm">{{ node.name }}</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-slate-50 border-t flex justify-end gap-2">
                    <button @click="closeCapabilityDomainGroupModal" class="btn btn-ghost">取消</button>
                    <button @click="confirmCapabilityDomainGroupModal" class="btn btn-primary px-8">确认</button>
                </div>
            </div>
        </dialog>

        <!-- Detail Preview Modal -->
        <dialog id="detail_preview_modal" class="modal">
            <div class="modal-box w-11/12 max-w-3xl p-0 overflow-hidden bg-white">
                <div class="bg-slate-800 text-white p-4 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-eye mr-2"></i>{{ previewModal.title }}</h3>
                    <button @click="closeDetailPreview" class="opacity-50 hover:opacity-100"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-4 space-y-2">
                    <div class="text-xs font-mono opacity-50">{{ previewModal.code }}</div>
                    <div class="font-bold text-lg">{{ previewModal.name }}</div>
                    <div class="text-sm whitespace-pre-wrap">{{ previewModal.description || '无描述' }}</div>
                </div>
                <div class="p-4 bg-slate-50 border-t flex justify-end gap-2">
                    <button @click="closeDetailPreview" class="btn btn-sm btn-ghost">关闭</button>
                    <button @click="openPreviewInEditor" class="btn btn-sm btn-primary">编辑</button>
                </div>
            </div>
        </dialog>

        <!-- Manage Data Modal -->
        <dialog id="manage_data_modal" class="modal">
            <div class="modal-box w-11/12 max-w-7xl p-0 overflow-hidden bg-white">
                <div class="bg-slate-800 text-white p-4 flex justify-between items-center">
                    <h3 class="font-bold"><i class="fas fa-database mr-2"></i>Manage Data - {{ editForm.table_name || '-' }}</h3>
                    <button @click="closeManageDataModal" class="opacity-60 hover:opacity-100"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-4 space-y-4 max-h-[75vh] overflow-auto">
                    <div class="grid grid-cols-12 gap-2 items-end">
                        <div class="col-span-3">
                            <label class="label py-1"><span class="label-text text-xs">Filter Field</span></label>
                            <select v-model="manageData.filter_field" class="select select-bordered select-sm w-full">
                                <option value="">-</option>
                                <option v-for="col in manageData.columns" :key="'f-'+col.field_name" :value="col.field_name">{{ col.field_name }}</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="label py-1"><span class="label-text text-xs">Operator</span></label>
                            <select v-model="manageData.filter_op" class="select select-bordered select-sm w-full">
                                <option value="eq">eq</option>
                                <option value="like">like</option>
                                <option value="in">in</option>
                            </select>
                        </div>
                        <div class="col-span-3">
                            <label class="label py-1"><span class="label-text text-xs">Value</span></label>
                            <input v-model="manageData.filter_value" class="input input-bordered input-sm w-full" />
                        </div>
                        <div class="col-span-2">
                            <label class="label py-1"><span class="label-text text-xs">Sort</span></label>
                            <select v-model="manageData.sort_field" class="select select-bordered select-sm w-full">
                                <option value="">-</option>
                                <option v-for="col in manageData.columns" :key="'s-'+col.field_name" :value="col.field_name">{{ col.field_name }}</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="label py-1"><span class="label-text text-xs">Dir</span></label>
                            <select v-model="manageData.sort_order" class="select select-bordered select-sm w-full">
                                <option value="asc">asc</option>
                                <option value="desc">desc</option>
                            </select>
                        </div>
                        <div class="col-span-1 flex gap-1">
                            <button @click="queryManageData(1)" class="btn btn-sm btn-primary">Query</button>
                        </div>
                    </div>

                    <div class="overflow-x-auto border rounded">
                        <table class="table table-xs w-full">
                            <thead class="bg-base-200">
                                <tr>
                                    <th v-for="col in manageData.columns" :key="'h-'+col.field_name">{{ col.field_name }}</th>
                                    <th class="w-20">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(row, idx) in manageData.items" :key="'r-'+idx">
                                    <td v-for="col in manageData.columns" :key="'c-'+idx+'-'+col.field_name">
                                        <span>{{ formatDataCell(row[col.field_name]) }}</span>
                                    </td>
                                    <td>
                                        <button @click="startEditDataRow(row)" class="btn btn-xs btn-outline">Edit</button>
                                    </td>
                                </tr>
                                <tr v-if="manageData.items.length === 0">
                                    <td :colspan="manageData.columns.length + 1" class="text-center py-4 opacity-50">No data</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="flex justify-between items-center">
                        <div class="text-xs opacity-60">Total: {{ manageData.total }} | Page {{ manageData.page }}</div>
                        <div class="flex gap-2">
                            <button @click="queryManageData(manageData.page - 1)" class="btn btn-xs" :disabled="manageData.page <= 1">Prev</button>
                            <button @click="queryManageData(manageData.page + 1)" class="btn btn-xs" :disabled="manageData.page * manageData.page_size >= manageData.total">Next</button>
                        </div>
                    </div>

                    <div class="border rounded p-3 space-y-2">
                        <div class="font-bold text-sm">Add Row</div>
                        <div class="grid grid-cols-2 gap-2">
                            <div v-for="col in manageData.columns" :key="'n-'+col.field_name">
                                <label class="label py-1"><span class="label-text text-xs">{{ col.field_name }}</span></label>
                                <input v-model="manageData.new_row[col.field_name]" class="input input-bordered input-sm w-full" />
                            </div>
                        </div>
                        <button @click="createManageDataRow" class="btn btn-sm btn-primary">Add</button>
                    </div>

                    <div v-if="manageData.editing_row_token" class="border rounded p-3 space-y-2">
                        <div class="font-bold text-sm">Edit Row</div>
                        <div class="grid grid-cols-2 gap-2">
                            <div v-for="col in manageData.columns" :key="'e-'+col.field_name">
                                <label class="label py-1"><span class="label-text text-xs">{{ col.field_name }}</span></label>
                                <input v-model="manageData.edit_row[col.field_name]" class="input input-bordered input-sm w-full" />
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button @click="saveEditDataRow" class="btn btn-sm btn-primary">Save</button>
                            <button @click="cancelEditDataRow" class="btn btn-sm btn-ghost">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </dialog>

        <dialog id="global_config_modal" class="modal">
            <div class="modal-box max-w-3xl p-0 overflow-hidden bg-base-100 border border-base-300 shadow-2xl">
                <!-- Modal Header -->
                <div class="bg-slate-800 text-white p-4 flex justify-between items-center shrink-0">
                    <h3 class="font-bold flex items-center gap-2">
                        <i class="fas fa-cog text-primary"></i> Global Configuration
                    </h3>
                    <button @click="closeGlobalConfigModal" class="opacity-50 hover:opacity-100 transition-opacity"><i class="fas fa-times"></i></button>
                </div>

                <!-- Modal Body with Tabs -->
                <div class="flex flex-col h-[70vh]">
                    <!-- Tab Navigation -->
                    <div class="flex bg-base-200 p-1 gap-1 shrink-0">
                        <button v-for="tab in [
                            { id: 'llm', name: 'LLM Settings', icon: 'fa-brain' },
                            { id: 'observability', name: 'Observability', icon: 'fa-wave-square' },
                            { id: 'weights', name: 'Search Weights', icon: 'fa-weight-hanging' },
                            { id: 'limits', name: 'Ranking & Limits', icon: 'fa-filter' },
                            { id: 'maintenance', name: 'Maintenance', icon: 'fa-tools' }
                        ]" 
                        :key="tab.id"
                        @click="activeConfigTab = tab.id"
                        :class="['flex-1 py-2 px-3 rounded-md text-sm font-medium transition-all flex items-center justify-center gap-2 whitespace-nowrap', 
                                activeConfigTab === tab.id ? 'bg-base-100 text-primary shadow-sm' : 'text-base-content/60 hover:bg-base-300']">
                            <i :class="['fas', tab.icon]"></i>
                            <span>{{ tab.name }}</span>
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="flex-1 overflow-auto p-6">
                        <!-- Tab: LLM Settings -->
                        <div v-if="activeConfigTab === 'llm'" class="space-y-6">
                            <div class="flex items-center gap-2 text-sm font-bold opacity-60 uppercase tracking-wider">
                                <i class="fas fa-id-badge text-primary"></i>
                                <span>Tenant Context</span>
                            </div>
                            <div class="bg-base-200/50 rounded-lg p-3 text-xs font-mono">
                                <span class="opacity-50">Current Tenant:</span> {{ config.tenantId }}
                            </div>

                            <div class="divider">Primary LLM</div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label class="label"><span class="label-text font-bold">Provider</span></label>
                                    <select v-model="tenantLlmConfig.provider" @change="handlePrimaryProviderChange" class="select select-bordered select-sm w-full">
                                        <option value="deepseek">deepseek</option>
                                        <option value="qwen">qwen</option>
                                    </select>
                                </div>
                                <div class="form-control">
                                    <label class="label"><span class="label-text font-bold">Model</span></label>
                                    <input v-model="tenantLlmConfig.model" class="input input-bordered input-sm w-full" placeholder="e.g. deepseek-reasoner" />
                                </div>
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-bold">API Key</span>
                                    <span v-if="tenantLlmConfig.api_key_masked" class="label-text-alt opacity-50 font-mono">Current: {{ tenantLlmConfig.api_key_masked }}</span>
                                </label>
                                <input v-model="tenantLlmConfig.api_key" type="password" class="input input-bordered input-sm w-full" placeholder="Enter new key to overwrite existing one" />
                            </div>

                            <div class="form-control">
                                <label class="label"><span class="label-text font-bold">Base URL (Optional)</span></label>
                                <input v-model="tenantLlmConfig.base_url" class="input input-bordered input-sm w-full" placeholder="https://api.example.com/v1" />
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label class="label"><span class="label-text font-bold">Timeout (ms)</span></label>
                                    <input v-model.number="tenantLlmConfig.timeout_ms" type="number" min="1000" step="1000" class="input input-bordered input-sm w-full" />
                                </div>
                                <div class="form-control">
                                    <label class="label"><span class="label-text font-bold">Enable Thinking</span></label>
                                    <select v-model="tenantLlmConfig.enable_thinking" class="select select-bordered select-sm w-full">
                                        <option :value="true">Enabled</option>
                                        <option :value="false">Disabled</option>
                                    </select>
                                </div>
                            </div>

                            <div class="divider">Fallback LLM</div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label class="label"><span class="label-text font-bold">Fallback Provider</span></label>
                                    <select v-model="tenantLlmConfig.fallback_provider" @change="handleFallbackProviderChange" class="select select-bordered select-sm w-full">
                                        <option value="">(none)</option>
                                        <option value="deepseek">deepseek</option>
                                        <option value="qwen">qwen</option>
                                    </select>
                                </div>
                                <div class="form-control">
                                    <label class="label"><span class="label-text font-bold">Fallback Model</span></label>
                                    <input v-model="tenantLlmConfig.fallback_model" class="input input-bordered input-sm w-full" placeholder="Optional fallback model" />
                                </div>
                            </div>

                            <div class="pt-4 border-t flex items-center gap-4">
                                <button @click="verifyTenantLlmConfig" class="btn btn-sm btn-outline gap-2" :disabled="loading">
                                    <i class="fas fa-vial"></i> Verify LLM
                                </button>
                                <div v-if="tenantLlmVerifyResult" :class="['text-xs px-3 py-1.5 rounded-full flex items-center gap-2', tenantLlmVerifyResult.ok ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700']">
                                    <i :class="['fas', tenantLlmVerifyResult.ok ? 'fa-check-circle' : 'fa-times-circle']"></i>
                                    <span>{{ tenantLlmVerifyResult.ok ? 'Verification Passed' : 'Verification Failed: ' + (tenantLlmVerifyResult.error || 'Unknown error') }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: Observability -->
                        <div v-if="activeConfigTab === 'observability'" class="space-y-6">
                            <div class="alert alert-info text-xs py-2 bg-blue-50 border-blue-100 text-blue-800">
                                <i class="fas fa-info-circle"></i>
                                <span>Langfuse config is runtime-level; updates take effect immediately for new trace events.</span>
                            </div>

                            <div class="form-control">
                                <label class="label cursor-pointer justify-start gap-2">
                                    <input type="checkbox" class="toggle toggle-primary toggle-sm" v-model="langfuseConfig.enabled" />
                                    <span class="label-text font-bold">Enable Langfuse</span>
                                </label>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label class="label"><span class="label-text font-bold">Public Key</span></label>
                                    <input v-model="langfuseConfig.public_key" class="input input-bordered input-sm w-full font-mono" placeholder="pk-lf-..." />
                                </div>
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-bold">Secret Key</span>
                                        <span v-if="langfuseConfig.secret_key_masked" class="label-text-alt opacity-50 font-mono">Current: {{ langfuseConfig.secret_key_masked }}</span>
                                    </label>
                                    <input v-model="langfuseConfig.secret_key" type="password" class="input input-bordered input-sm w-full font-mono" placeholder="sk-lf-... (leave empty to keep)" />
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label class="label"><span class="label-text font-bold">Host</span></label>
                                    <input v-model="langfuseConfig.host" class="input input-bordered input-sm w-full font-mono" placeholder="http://localhost:3000" />
                                </div>
                                <div class="form-control">
                                    <label class="label"><span class="label-text font-bold">Environment</span></label>
                                    <input v-model="langfuseConfig.environment" class="input input-bordered input-sm w-full font-mono" placeholder="dev / prod" />
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-control">
                                    <label class="label"><span class="label-text font-bold">Release</span></label>
                                    <input v-model="langfuseConfig.release" class="input input-bordered input-sm w-full font-mono" placeholder="e.g. v0.3.1" />
                                </div>
                                <div class="form-control">
                                    <label class="label"><span class="label-text font-bold">Audit Payload Max Chars</span></label>
                                    <input v-model.number="langfuseConfig.audit_payload_max_chars" type="number" min="2000" max="200000" step="1000" class="input input-bordered input-sm w-full font-mono" />
                                </div>
                            </div>
                        </div>

                        <!-- Tab: Search Weights -->
                        <div v-if="activeConfigTab === 'weights'" class="space-y-8">
                            <div class="alert alert-info text-xs py-2 bg-blue-50 border-blue-100 text-blue-800">
                                <i class="fas fa-info-circle"></i>
                                <span>Sparse (Keyword) and Dense (Vector) weights define how search results are ranked.</span>
                            </div>

                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-bold text-sm">Word Search (Token &le; 2)</h4>
                                    <span class="badge badge-sm badge-ghost font-mono">Word Mode</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4 bg-base-200/30 p-4 rounded-xl border border-base-200">
                                    <div class="form-control">
                                        <label class="label"><span class="label-text text-xs opacity-60 font-bold">Keyword Weight (w_sparse)</span></label>
                                        <input v-model.number="globalSearchConfig.word_w_sparse" type="number" min="0" step="0.01" class="input input-bordered input-sm w-full" />
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text text-xs opacity-60 font-bold">Vector Weight (w_dense)</span></label>
                                        <input v-model.number="globalSearchConfig.word_w_dense" type="number" min="0" step="0.01" class="input input-bordered input-sm w-full" />
                                    </div>
                                    <div class="col-span-2 pt-2 border-t border-base-200 mt-2">
                                        <div class="flex justify-between items-center text-[10px] font-mono opacity-60">
                                            <span>Effective Ratio:</span>
                                            <div class="flex gap-4">
                                                <span>Sparse: {{ effectiveWeightRatioWord.sparse }}</span>
                                                <span>Dense: {{ effectiveWeightRatioWord.dense }}</span>
                                            </div>
                                        </div>
                                        <div class="w-full bg-base-200 h-1 rounded-full mt-2 overflow-hidden flex">
                                            <div class="h-full bg-primary" :style="{ width: (effectiveWeightRatioWord.sparse * 100) + '%' }"></div>
                                            <div class="h-full bg-accent" :style="{ width: (effectiveWeightRatioWord.dense * 100) + '%' }"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-bold text-sm">Sentence Search (Token > 2)</h4>
                                    <span class="badge badge-sm badge-ghost font-mono">Semantic Mode</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4 bg-base-200/30 p-4 rounded-xl border border-base-200">
                                    <div class="form-control">
                                        <label class="label"><span class="label-text text-xs opacity-60 font-bold">Keyword Weight (w_sparse)</span></label>
                                        <input v-model.number="globalSearchConfig.sentence_w_sparse" type="number" min="0" step="0.01" class="input input-bordered input-sm w-full" />
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text text-xs opacity-60 font-bold">Vector Weight (w_dense)</span></label>
                                        <input v-model.number="globalSearchConfig.sentence_w_dense" type="number" min="0" step="0.01" class="input input-bordered input-sm w-full" />
                                    </div>
                                    <div class="col-span-2 pt-2 border-t border-base-200 mt-2">
                                        <div class="flex justify-between items-center text-[10px] font-mono opacity-60">
                                            <span>Effective Ratio:</span>
                                            <div class="flex gap-4">
                                                <span>Sparse: {{ effectiveWeightRatioSentence.sparse }}</span>
                                                <span>Dense: {{ effectiveWeightRatioSentence.dense }}</span>
                                            </div>
                                        </div>
                                        <div class="w-full bg-base-200 h-1 rounded-full mt-2 overflow-hidden flex">
                                            <div class="h-full bg-primary" :style="{ width: (effectiveWeightRatioSentence.sparse * 100) + '%' }"></div>
                                            <div class="h-full bg-accent" :style="{ width: (effectiveWeightRatioSentence.dense * 100) + '%' }"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: Ranking & Limits -->
                        <div v-if="activeConfigTab === 'limits'" class="space-y-6">
                            <div class="section-card p-4 space-y-4">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text font-bold">Top-N Results</span>
                                        <span class="label-text-alt opacity-50">1 - 500</span>
                                    </label>
                                    <div class="flex items-center gap-4">
                                        <input type="range" min="1" max="500" v-model.number="globalSearchConfig.top_n" class="range range-xs range-primary flex-1" />
                                        <input v-model.number="globalSearchConfig.top_n" type="number" class="input input-bordered input-xs w-20 text-center font-mono" />
                                    </div>
                                    <label class="label"><span class="label-text-alt opacity-50">Maximum number of candidates retrieved before reranking.</span></label>
                                </div>

                                <div class="grid grid-cols-2 gap-6">
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-bold">Score Gap</span></label>
                                        <input v-model.number="globalSearchConfig.score_gap" type="number" min="0" step="0.01" class="input input-bordered input-sm w-full font-mono" />
                                        <label class="label"><span class="label-text-alt opacity-50 text-[10px]">Filter out results with large score drops.</span></label>
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-bold">Relative Difference</span></label>
                                        <input v-model.number="globalSearchConfig.relative_diff" type="number" min="0" step="0.01" class="input input-bordered input-sm w-full font-mono" />
                                        <label class="label"><span class="label-text-alt opacity-50 text-[10px]">Score threshold relative to max score.</span></label>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-base-200 p-4 rounded-lg">
                                <h5 class="text-xs font-bold uppercase opacity-50 mb-2">Filtering Logic</h5>
                                <p class="text-[11px] leading-relaxed opacity-70">
                                    Results must satisfy <strong>all</strong> of the following conditions:
                                </p>
                                <ul class="list-disc list-inside text-[11px] mt-2 space-y-1 opacity-70 ml-2">
                                    <li>Within the <strong>Top-N</strong> candidates</li>
                                    <li>Difference with previous score &le; <strong>Score Gap</strong> (if > 0)</li>
                                    <li>Score &ge; <strong>Max Score</strong> &times; (1 - <strong>Relative Difference</strong>)</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Tab: Maintenance -->
                        <div v-if="activeConfigTab === 'maintenance'" class="space-y-6">
                            <div class="section-card border-l-4 border-l-primary p-4 bg-primary/5">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary">
                                        <i class="fas fa-database fa-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold">Embedding Backfill</h4>
                                        <p class="text-xs opacity-60">Synchronize vector database with ontology changes.</p>
                                    </div>
                                </div>

                                <div class="space-y-4">
                                    <div class="form-control">
                                        <label class="label"><span class="label-text font-bold">Batch Size</span></label>
                                        <input v-model.number="globalSearchConfig.backfill_batch_size" type="number" min="1" max="5000" step="1" class="input input-bordered input-sm w-full max-w-xs font-mono" />
                                        <label class="label"><span class="label-text-alt opacity-50">Recommended: 200 - 500</span></label>
                                    </div>

                                    <button @click="triggerEmbeddingBackfill" class="btn btn-sm btn-primary gap-2" :disabled="loading">
                                        <span v-if="loading" class="loading loading-spinner loading-xs"></span>
                                        <i v-else class="fas fa-sync-alt"></i>
                                        Run Offline Backfill
                                    </button>
                                </div>
                            </div>

                            <div v-if="backfillResult" class="bg-base-200 rounded-lg p-4 space-y-3 shadow-inner">
                                <div class="flex items-center justify-between border-b border-base-300 pb-2">
                                    <span class="text-xs font-bold uppercase opacity-50">Last Result</span>
                                    <span :class="['badge badge-sm', backfillResult.has_more_any ? 'badge-warning' : 'badge-success']">
                                        {{ backfillResult.has_more_any ? 'Has More Data' : 'All Synchronized' }}
                                    </span>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="stat p-0">
                                        <div class="stat-label text-[10px] opacity-50">Total Updated</div>
                                        <div class="stat-value text-xl">{{ backfillResult.updated_total }}</div>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="flex justify-between text-[10px]">
                                            <span class="opacity-50">Ontology:</span>
                                            <span class="font-mono">{{ backfillResult.updated?.ontology || 0 }}</span>
                                        </div>
                                        <div class="flex justify-between text-[10px]">
                                            <span class="opacity-50">Obj-Prop:</span>
                                            <span class="font-mono">{{ backfillResult.updated?.['obj-prop'] || 0 }}</span>
                                        </div>
                                        <div class="flex justify-between text-[10px]">
                                            <span class="opacity-50">Capability:</span>
                                            <span class="font-mono">{{ backfillResult.updated?.capability || 0 }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Actions -->
                <div class="p-4 bg-slate-50 border-t flex justify-between items-center shrink-0">
                    <button @click="resetGlobalSearchWeights" class="btn btn-sm btn-outline btn-ghost gap-2 text-xs">
                        <i class="fas fa-undo"></i> Reset Search Defaults
                    </button>
                    <div class="flex gap-2">
                        <button @click="closeGlobalConfigModal" class="btn btn-sm btn-ghost px-6">Cancel</button>
                        <button @click="saveGlobalConfig" class="btn btn-sm btn-primary px-10 shadow-lg shadow-primary/20">Save All Changes</button>
                    </div>
                </div>
            </div>
        </dialog>

        <!-- Toasts -->
        <div class="toast toast-end toast-bottom z-50">
            <div v-for="t in toasts" :key="t.id" :class="['alert shadow-2xl border-none text-white', t.type === 'error' ? 'bg-rose-500' : 'bg-emerald-500']">
                <span>{{ t.msg }}</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
        const { createApp, ref, reactive, computed, onMounted, onBeforeUnmount, watch } = Vue;

        const TreeItem = {
            name: 'TreeItem',
            props: ['node', 'activeId'],
            emits: ['select', 'add-child'],
            setup() {
                const expanded = ref(false);
                return { expanded };
            },
            template: `
                <div class="tree-node-wrap">
                    <div @click="$emit('select', node)"
                        :class="['px-2 py-1.5 cursor-pointer rounded flex items-center gap-2 group text-sm transition-colors', activeId === node.id ? 'active-item font-bold' : 'hover:bg-base-200']">
                        <button v-if="node.children && node.children.length" @click.stop="expanded = !expanded" class="w-4 h-4 flex items-center justify-center opacity-60 hover:opacity-100">
                            <i class="fas fa-xs" :class="expanded ? 'fa-minus-square' : 'fa-plus-square'"></i>
                        </button>
                        <span v-else class="w-4"></span>
                        <i v-if="node.children && node.children.length" class="fas fa-folder text-amber-500 opacity-60"></i>
                        <i v-else class="fas fa-cube text-blue-400 opacity-60"></i>
                        <span class="flex-1 truncate">{{ node.name }}</span>
                        <button @click.stop="$emit('add-child', node)" class="opacity-0 group-hover:opacity-100 hover:text-primary"><i class="fas fa-plus-circle text-xs"></i></button>
                    </div>
                    <div v-if="expanded && node.children && node.children.length" class="tree-node">
                        <tree-item v-for="child in node.children" :key="child.id" :node="child" :active-id="activeId" @select="$emit('select', $event)" @add-child="$emit('add-child', $event)"></tree-item>
                    </div>
                </div>
            `
        };

        createApp({
            components: { TreeItem },
            setup() {
                const activeTab = ref('ontology');
                const activeConfigTab = ref('llm');
                const selectedId = ref(null);
                const selectedItem = ref(null);
                const searchQuery = ref('');
                const submittedSearchQuery = ref('');
                const attrSearchQuery = ref('');
                const loading = ref(false);
                const showLogs = ref(false);
                const logs = ref([]);
                const toasts = ref([]);
                const tempDirectAttrIds = ref([]);
                const classPickerTarget = ref('');
                const classPickerSelection = ref([]);
                const classPickerTitle = ref('选择本体');
                const tempCapDomainGroups = ref([]);
                const activeTempGroupIndex = ref(0);
                const capDomainForCreate = ref(false);
                const previewModal = reactive({ tab: '', id: null, title: '', code: '', name: '', description: '' });
                const theme = ref(localStorage.getItem('uiTheme') || 'light');
                const isDarkTheme = computed(() => theme.value === 'dark');

                const config = reactive({
                    tenantId: localStorage.getItem('tenantId') || 'tenant-a',
                    token: localStorage.getItem('token') || 'test-token'
                });
                const globalSearchConfig = reactive({
                    word_w_sparse: 0.45,
                    word_w_dense: 0.55,
                    sentence_w_sparse: 0.25,
                    sentence_w_dense: 0.75,
                    top_n: 200,
                    score_gap: 0,
                    relative_diff: 0,
                    backfill_batch_size: 200,
                });
                const tenantLlmConfig = reactive({
                    provider: 'deepseek',
                    model: 'deepseek-reasoner',
                    api_key: '',
                    api_key_masked: '',
                    api_key_masked_by_provider: {},
                    base_url: '',
                    timeout_ms: 30000,
                    enable_thinking: true,
                    fallback_provider: '',
                    fallback_model: '',
                    extra_json: {},
                });
                const langfuseConfig = reactive({
                    enabled: false,
                    public_key: '',
                    secret_key: '',
                    secret_key_masked: '',
                    host: 'http://localhost:3000',
                    environment: 'dev',
                    release: '',
                    audit_payload_max_chars: 24000,
                });
                const llmProviderPresets = Object.freeze({
                    deepseek: {
                        model: 'deepseek-reasoner',
                        base_url: 'https://api.deepseek.com',
                        enable_thinking: false,
                    },
                    qwen: {
                        model: 'qwen3.5-plus',
                        base_url: 'https://dashscope.aliyuncs.com/compatible-mode/v1',
                        enable_thinking: true,
                    },
                });
                const tenantLlmVerifyResult = ref(null);
                const backfillResult = ref(null);

                const tabs = [
                    { id: 'ontology', name: 'Ontologies', icon: 'fa-sitemap' },
                    { id: 'data-attr', name: 'Data Attributes', icon: 'fa-list' },
                    { id: 'obj-prop', name: 'Object Properties', icon: 'fa-project-diagram' },
                    { id: 'capability', name: 'Capabilities', icon: 'fa-bolt' }
                ];

                const currentTabName = computed(() => tabs.find(t => t.id === activeTab.value).name);
                const currentTabIcon = computed(() => tabs.find(t => t.id === activeTab.value).icon);
                const calcEffectiveWeightRatio = (ws, wd) => {
                    const total = ws + wd;
                    if (total <= 0) return { sparse: '0.4500', dense: '0.5500' };
                    return {
                        sparse: (ws / total).toFixed(4),
                        dense: (wd / total).toFixed(4),
                    };
                };
                const effectiveWeightRatioWord = computed(() => calcEffectiveWeightRatio(
                    Number(globalSearchConfig.word_w_sparse) || 0,
                    Number(globalSearchConfig.word_w_dense) || 0,
                ));
                const effectiveWeightRatioSentence = computed(() => calcEffectiveWeightRatio(
                    Number(globalSearchConfig.sentence_w_sparse) || 0,
                    Number(globalSearchConfig.sentence_w_dense) || 0,
                ));

                const ontologyTree = ref([]);
                const flatOntologies = ref([]);
                const dataAttrs = ref([]);
                const objectProps = ref([]);
                const capabilities = ref([]);
                const hybridMatchIds = reactive({
                    ontology: null,
                    'data-attr': null,
                    'obj-prop': null,
                    capability: null,
                });
                const hybridMatchOrder = reactive({
                    ontology: null,
                    'data-attr': null,
                    'obj-prop': null,
                    capability: null,
                });

                const editForm = reactive({
                    name: '', description: '', data_type: 'string', skill_md: '',
                    directAttrIds: [], inheritedAttrIds: [], domain_ids: [], range_ids: [],
                    cap_domain_groups: [],
                    table_name: '', table_schema: 'public', field_mappings: {}
                });

                const createForm = reactive({
                    code: '', name: '', description: '', parentCode: '', data_type: 'string', skill_md: '',
                    domain_ids: [], range_ids: [], cap_domain_groups: []
                });
                const manageData = reactive({
                    page: 1,
                    page_size: 20,
                    total: 0,
                    items: [],
                    columns: [],
                    filter_field: '',
                    filter_op: 'eq',
                    filter_value: '',
                    sort_field: '',
                    sort_order: 'asc',
                    new_row: {},
                    edit_row: {},
                    editing_row_token: ''
                });

                const filteredTree = computed(() => {
                    if (!submittedSearchQuery.value) return ontologyTree.value;
                    if (hybridMatchOrder.ontology instanceof Array) return ontologyTree.value;
                    if (hybridMatchIds.ontology instanceof Set) {
                        const filterByIds = (nodes) => (nodes || []).reduce((acc, n) => {
                            const children = filterByIds(n.children || []);
                            if (hybridMatchIds.ontology.has(Number(n.id)) || children.length > 0) {
                                acc.push({ ...n, children });
                            }
                            return acc;
                        }, []);
                        return filterByIds(ontologyTree.value);
                    }
                    // Avoid local pre-filter flash; wait for backend hybrid-search result.
                    return ontologyTree.value;
                });

                const filteredOntologyList = computed(() => {
                    let list = flatOntologies.value;
                    const ordered = hybridMatchOrder.ontology;
                    const matched = hybridMatchIds.ontology;
                    if (submittedSearchQuery.value && ordered instanceof Array) {
                        const byId = new Map(list.map(item => [Number(item.id), item]));
                        return ordered.map(id => byId.get(Number(id))).filter(Boolean);
                    }
                    if (submittedSearchQuery.value && matched instanceof Set) {
                        list = list.filter(i => matched.has(Number(i.id)));
                        return list;
                    }
                    if (submittedSearchQuery.value) return list;
                    return list;
                });
                const showOntologySearchResultList = computed(() => {
                    return activeTab.value === 'ontology' && !!submittedSearchQuery.value;
                });

                const filteredList = computed(() => {
                    let list = activeTab.value === 'data-attr' ? dataAttrs.value : (activeTab.value === 'obj-prop' ? objectProps.value : capabilities.value);
                    const matched = hybridMatchIds[activeTab.value];
                    const ordered = hybridMatchOrder[activeTab.value];
                    if (submittedSearchQuery.value && ordered instanceof Array) {
                        const byId = new Map(list.map(item => [Number(item.id), item]));
                        return ordered.map(id => byId.get(Number(id))).filter(Boolean);
                    }
                    if (submittedSearchQuery.value && matched instanceof Set) {
                        list = list.filter(i => matched.has(Number(i.id)));
                        return list;
                    }
                    if (submittedSearchQuery.value) return list;
                    return list;
                });

                const filteredAllAttrs = computed(() => {
                    if (!attrSearchQuery.value) return dataAttrs.value;
                    return dataAttrs.value.filter(a => a.name.toLowerCase().includes(attrSearchQuery.value.toLowerCase()) || a.code.toLowerCase().includes(attrSearchQuery.value.toLowerCase()));
                });
                const flatClassTreeWithDepth = computed(() => {
                    const out = [];
                    const walk = (nodes, depth = 0) => {
                        for (const node of (nodes || [])) {
                            out.push({ id: node.id, name: node.name, depth });
                            walk(node.children || [], depth + 1);
                        }
                    };
                    walk(ontologyTree.value, 0);
                    return out;
                });

                const boundAttributesList = computed(() => {
                    const allIds = [...new Set([...editForm.directAttrIds, ...editForm.inheritedAttrIds])];
                    return dataAttrs.value.filter(a => allIds.includes(a.id)).sort((a,b) => a.id - b.id);
                });

                const boundOntologies = computed(() => {
                    if (!selectedId.value) return [];
                    if (activeTab.value === 'data-attr') return flatOntologies.value.filter(o => o.bound_attrs?.includes(selectedId.value));
                    if (activeTab.value === 'capability') return flatOntologies.value.filter(o => o.bound_caps?.includes(selectedId.value));
                    return [];
                });
                const selectedDomainClasses = computed(() => flatOntologies.value.filter(cls => (editForm.domain_ids || []).includes(cls.id)));
                const selectedRangeClasses = computed(() => flatOntologies.value.filter(cls => (editForm.range_ids || []).includes(cls.id)));
                const selectedItemRelations = computed(() => {
                    if (activeTab.value !== 'ontology' || !selectedId.value) return [];
                    const ancestorIds = new Set((selectedItem.value?.ancestor_ids || []).map(Number));
                    const scopeIds = new Set([Number(selectedId.value), ...ancestorIds]);
                    return objectProps.value
                        .filter(p => {
                            const domainIds = (p.domain_class_ids || []).map(Number);
                            const rangeIds = (p.range_class_ids || []).map(Number);
                            return domainIds.some(id => scopeIds.has(id)) || rangeIds.some(id => scopeIds.has(id));
                        })
                        .map(p => {
                            const domainIds = new Set((p.domain_class_ids || []).map(Number));
                            const rangeIds = new Set((p.range_class_ids || []).map(Number));
                            const scopeInDomain = [...scopeIds].some(id => domainIds.has(id));
                            const scopeInRange = [...scopeIds].some(id => rangeIds.has(id));
                            const selfInDomain = domainIds.has(Number(selectedId.value));
                            const selfInRange = rangeIds.has(Number(selectedId.value));
                            const role = scopeInDomain && scopeInRange ? 'domain/range' : (scopeInDomain ? 'domain' : 'range');
                            const source = (selfInDomain || selfInRange) ? 'Direct' : 'Inherited';
                            return { ...p, roleText: `${role} · ${source}`, source };
                        });
                });
                const selectedItemCapabilities = computed(() => {
                    if (activeTab.value !== 'ontology' || !selectedId.value) return [];
                    const ancestorIds = new Set((selectedItem.value?.ancestor_ids || []).map(Number));
                    const scopeIds = new Set([Number(selectedId.value), ...ancestorIds]);
                    return capabilities.value
                        .filter(c => {
                            const inScopeGroup = (c.domain_groups || []).some(g => (g || []).map(Number).some(id => scopeIds.has(id)));
                            return inScopeGroup || selectedItem.value.bound_caps?.includes(c.id);
                        })
                        .map(c => {
                            const selfInGroup = (c.domain_groups || []).some(g => (g || []).map(Number).includes(Number(selectedId.value)));
                            const source = selfInGroup ? 'Direct' : 'Inherited';
                            return { ...c, roleText: `domain · ${source}`, source };
                        });
                });
                const formatDateTime = (date = new Date()) => {
                    const pad = (n) => String(n).padStart(2, '0');
                    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
                };
                const ideLog = (...args) => {
                    console.log(`[${formatDateTime()}]`, ...args);
                };
                const formatDataCell = (value) => {
                    if (value === null || value === undefined) return '';
                    if (typeof value === 'object') return JSON.stringify(value);
                    return String(value);
                };
                const parseInputValueByType = (raw, dataType) => {
                    if (raw === '' || raw === null || raw === undefined) return null;
                    if (dataType === 'int') return Number(raw);
                    if (dataType === 'boolean') return String(raw).toLowerCase() === 'true' || String(raw) === '1';
                    if (dataType === 'json' || dataType === 'array') return JSON.parse(raw);
                    return raw;
                };

                const call = async (method, path, body = null) => {
                    loading.value = true;
                    try {
                        const res = await fetch(path, {
                            method,
                            headers: { "Content-Type": "application/json", "X-Tenant-Id": config.tenantId, "Authorization": `Bearer ${config.token}` },
                            body: body ? JSON.stringify(body) : null
                        });
                        const data = await res.json();
                        logs.value.unshift({ time: formatDateTime(), method, path, data, error: data.code !== 0 });
                        if (data.code !== 0) throw new Error(data.message);
                        return data.data;
                    } catch (e) {
                        toast(e.message, 'error');
                        return null;
                    } finally {
                        loading.value = false;
                    }
                };

                const countQueryTokens = (query) => {
                    const q = String(query || '').trim().toLowerCase();
                    if (!q) return 0;
                    const spaced = q.split(/\s+/).filter(Boolean);
                    if (spaced.length > 1) return spaced.length;
                    const cjk = q.match(/[\u4e00-\u9fff]/g);
                    if (cjk && cjk.length) return cjk.length;
                    return 1;
                };
                const getWeightsForQuery = (query) => {
                    const tokenCount = countQueryTokens(query);
                    if (tokenCount <= 2) {
                        return {
                            w_sparse: Number(globalSearchConfig.word_w_sparse),
                            w_dense: Number(globalSearchConfig.word_w_dense),
                        };
                    }
                    return {
                        w_sparse: Number(globalSearchConfig.sentence_w_sparse),
                        w_dense: Number(globalSearchConfig.sentence_w_dense),
                    };
                };

                const runHybridSearch = async () => {
                    const q = (submittedSearchQuery.value || '').trim();
                    if (!q) {
                        hybridMatchIds.ontology = null;
                        hybridMatchIds['data-attr'] = null;
                        hybridMatchIds['obj-prop'] = null;
                        hybridMatchIds.capability = null;
                        hybridMatchOrder.ontology = null;
                        hybridMatchOrder['data-attr'] = null;
                        hybridMatchOrder['obj-prop'] = null;
                        hybridMatchOrder.capability = null;
                        return;
                    }
                    const type = activeTab.value;
                    const topN = Math.max(1, Math.min(500, Math.floor(Number(globalSearchConfig.top_n) || 200)));
                    const scoreGap = Math.max(0, Number(globalSearchConfig.score_gap) || 0);
                    const relativeDiff = Math.max(0, Number(globalSearchConfig.relative_diff) || 0);
                    const weights = getWeightsForQuery(q);
                    hybridMatchIds[type] = null;
                    hybridMatchOrder[type] = null;
                    const params = new URLSearchParams({
                        q,
                        types: type,
                        top_k: String(topN),
                        score_gap: String(scoreGap),
                        relative_diff: String(relativeDiff),
                        w_sparse: String(weights.w_sparse),
                        w_dense: String(weights.w_dense),
                    });
                    try {
                        const res = await fetch(`/api/v1/ontology/hybrid-search?${params.toString()}`, {
                            method: 'GET',
                            headers: { "X-Tenant-Id": config.tenantId, "Authorization": `Bearer ${config.token}` },
                        });
                        const payload = await res.json();
                        if (!res.ok || payload.code !== 0) return;
                        const ids = (((payload.data || {}).grouped || {})[type] || []).map(Number);
                        const ordered = (((payload.data || {}).items || [])
                            .filter(item => item.resource_type === type)
                            .map(item => Number(item.id)));
                        hybridMatchIds[type] = new Set(ids);
                        hybridMatchOrder[type] = ordered;
                    } catch (_err) {
                        // Keep local fallback filtering when hybrid search request fails.
                    }
                };
                const executeSearch = () => {
                    submittedSearchQuery.value = (searchQuery.value || '').trim();
                    runHybridSearch();
                };

                const toast = (msg, type = 'success') => {
                    const id = Date.now();
                    toasts.value.push({ id, msg, type });
                    setTimeout(() => toasts.value = toasts.value.filter(t => t.id !== id), 3000);
                };

                const applyTheme = (nextTheme) => {
                    theme.value = nextTheme === 'dark' ? 'dark' : 'light';
                    document.documentElement.setAttribute('data-theme', theme.value);
                    const lightStyle = document.getElementById('hljs-light');
                    const darkStyle = document.getElementById('hljs-dark');
                    if (lightStyle && darkStyle) {
                        const darkEnabled = theme.value === 'dark';
                        lightStyle.disabled = darkEnabled;
                        darkStyle.disabled = !darkEnabled;
                    }
                    localStorage.setItem('uiTheme', theme.value);
                };
                const toggleTheme = () => applyTheme(theme.value === 'dark' ? 'light' : 'dark');
                const openGraphWorkspace = () => window.open('/theworld/v1/console/graph', '_blank', 'noopener,noreferrer');
                const applyPrimaryProviderPreset = (provider) => {
                    const preset = llmProviderPresets[String(provider || '').trim().toLowerCase()];
                    if (!preset) return;
                    tenantLlmConfig.model = preset.model;
                    tenantLlmConfig.base_url = preset.base_url;
                    tenantLlmConfig.enable_thinking = !!preset.enable_thinking;
                };
                const handlePrimaryProviderChange = () => {
                    applyPrimaryProviderPreset(tenantLlmConfig.provider);
                    const provider = String(tenantLlmConfig.provider || '').trim().toLowerCase();
                    tenantLlmConfig.api_key = '';
                    tenantLlmConfig.api_key_masked = tenantLlmConfig.api_key_masked_by_provider?.[provider] || '';
                };
                const handleFallbackProviderChange = () => {
                    const provider = String(tenantLlmConfig.fallback_provider || '').trim().toLowerCase();
                    if (!provider) {
                        tenantLlmConfig.fallback_model = '';
                        return;
                    }
                    const preset = llmProviderPresets[provider];
                    if (preset) tenantLlmConfig.fallback_model = preset.model;
                };
                const loadTenantLlmConfig = async () => {
                    const res = await call('GET', '/api/v1/config/tenant-llm');
                    if (!res) return;
                    tenantLlmConfig.provider = res.provider || 'deepseek';
                    tenantLlmConfig.model = res.model || 'deepseek-reasoner';
                    tenantLlmConfig.api_key = '';
                    tenantLlmConfig.api_key_masked_by_provider = res.api_key_masked_by_provider || {};
                    tenantLlmConfig.api_key_masked = tenantLlmConfig.api_key_masked_by_provider?.[tenantLlmConfig.provider] || res.api_key_masked || '';
                    tenantLlmConfig.base_url = res.base_url || '';
                    tenantLlmConfig.timeout_ms = Number(res.timeout_ms || 30000);
                    tenantLlmConfig.enable_thinking = !!res.enable_thinking;
                    tenantLlmConfig.fallback_provider = res.fallback_provider || '';
                    tenantLlmConfig.fallback_model = res.fallback_model || '';
                    tenantLlmConfig.extra_json = res.extra_json || {};
                    tenantLlmVerifyResult.value = null;
                };
                const loadLangfuseConfig = async () => {
                    const res = await call('GET', '/api/v1/config/observability/langfuse');
                    if (!res) return;
                    langfuseConfig.enabled = !!res.enabled;
                    langfuseConfig.public_key = res.public_key || '';
                    langfuseConfig.secret_key = '';
                    langfuseConfig.secret_key_masked = res.secret_key_masked || '';
                    langfuseConfig.host = res.host || 'http://localhost:3000';
                    langfuseConfig.environment = res.environment || 'dev';
                    langfuseConfig.release = res.release || '';
                    langfuseConfig.audit_payload_max_chars = Number(res.audit_payload_max_chars || 24000);
                };
                const loadTenantSearchConfig = async () => {
                    const res = await call('GET', '/api/v1/config/tenant-search-config');
                    if (!res) return;
                    globalSearchConfig.word_w_sparse = Number(res.word_w_sparse ?? globalSearchConfig.word_w_sparse);
                    globalSearchConfig.word_w_dense = Number(res.word_w_dense ?? globalSearchConfig.word_w_dense);
                    globalSearchConfig.sentence_w_sparse = Number(res.sentence_w_sparse ?? globalSearchConfig.sentence_w_sparse);
                    globalSearchConfig.sentence_w_dense = Number(res.sentence_w_dense ?? globalSearchConfig.sentence_w_dense);
                    globalSearchConfig.top_n = Number(res.top_n ?? globalSearchConfig.top_n);
                    globalSearchConfig.score_gap = Number(res.score_gap ?? globalSearchConfig.score_gap);
                    globalSearchConfig.relative_diff = Number(res.relative_diff ?? globalSearchConfig.relative_diff);
                    globalSearchConfig.backfill_batch_size = Number(res.backfill_batch_size ?? globalSearchConfig.backfill_batch_size);
                };
                const openGlobalConfigModal = async () => {
                    await loadTenantLlmConfig();
                    await loadTenantSearchConfig();
                    await loadLangfuseConfig();
                    document.getElementById('global_config_modal').showModal();
                };
                const closeGlobalConfigModal = () => document.getElementById('global_config_modal').close();
                const verifyTenantLlmConfig = async () => {
                    const payload = {
                        provider: tenantLlmConfig.provider || undefined,
                        model: tenantLlmConfig.model || undefined,
                        api_key: tenantLlmConfig.api_key || undefined,
                        base_url: tenantLlmConfig.base_url || undefined,
                        timeout_ms: Number(tenantLlmConfig.timeout_ms) || undefined,
                    };
                    const res = await call('POST', '/api/v1/config/tenant-llm:verify', payload);
                    if (!res) return;
                    tenantLlmVerifyResult.value = res;
                    toast(res.ok ? 'LLM verify success' : `LLM verify failed: ${res.error || 'unknown'}`, res.ok ? 'success' : 'error');
                };
                const saveTenantLlmConfig = async () => {
                    if (!tenantLlmConfig.provider || !tenantLlmConfig.model) {
                        toast('Provider/Model is required', 'error');
                        return false;
                    }
                    const currentProvider = String(tenantLlmConfig.provider || '').trim().toLowerCase();
                    const hasCurrentProviderKey = !!(
                        tenantLlmConfig.api_key
                        || tenantLlmConfig.api_key_masked
                        || tenantLlmConfig.api_key_masked_by_provider?.[currentProvider]
                    );
                    if (!hasCurrentProviderKey) {
                        toast('API Key is required for first-time setup', 'error');
                        return false;
                    }
                    const payload = {
                        provider: tenantLlmConfig.provider,
                        model: tenantLlmConfig.model,
                        api_key: tenantLlmConfig.api_key || undefined,
                        base_url: tenantLlmConfig.base_url || null,
                        timeout_ms: Math.max(1000, Number(tenantLlmConfig.timeout_ms) || 30000),
                        enable_thinking: !!tenantLlmConfig.enable_thinking,
                        fallback_provider: tenantLlmConfig.fallback_provider || null,
                        fallback_model: tenantLlmConfig.fallback_model || null,
                        extra_json: tenantLlmConfig.extra_json || {},
                        status: 1,
                    };
                    const res = await call('PUT', '/api/v1/config/tenant-llm', payload);
                    if (!res) return false;
                    tenantLlmConfig.api_key = '';
                    tenantLlmConfig.api_key_masked_by_provider = res.api_key_masked_by_provider || tenantLlmConfig.api_key_masked_by_provider || {};
                    tenantLlmConfig.api_key_masked = tenantLlmConfig.api_key_masked_by_provider?.[currentProvider] || res.api_key_masked || tenantLlmConfig.api_key_masked;
                    tenantLlmConfig.extra_json = res.extra_json || tenantLlmConfig.extra_json || {};
                    return true;
                };
                const saveLangfuseConfig = async () => {
                    const nextEnabled = !!langfuseConfig.enabled;
                    const nextPublic = String(langfuseConfig.public_key || '').trim();
                    const hasSecret = !!(String(langfuseConfig.secret_key || '').trim() || String(langfuseConfig.secret_key_masked || '').trim());
                    if (nextEnabled && (!nextPublic || !hasSecret)) {
                        toast('Langfuse enabled requires Public Key and Secret Key', 'error');
                        return false;
                    }
                    const payload = {
                        enabled: nextEnabled,
                        public_key: nextPublic || null,
                        secret_key: String(langfuseConfig.secret_key || '').trim() || null,
                        host: String(langfuseConfig.host || '').trim() || null,
                        environment: String(langfuseConfig.environment || '').trim() || null,
                        release: String(langfuseConfig.release || '').trim() || null,
                        audit_payload_max_chars: Math.max(2000, Math.min(200000, Number(langfuseConfig.audit_payload_max_chars) || 24000)),
                    };
                    const res = await call('PUT', '/api/v1/config/observability/langfuse', payload);
                    if (!res) return false;
                    langfuseConfig.enabled = !!res.enabled;
                    langfuseConfig.public_key = res.public_key || '';
                    langfuseConfig.secret_key = '';
                    langfuseConfig.secret_key_masked = res.secret_key_masked || langfuseConfig.secret_key_masked;
                    langfuseConfig.host = res.host || langfuseConfig.host || 'http://localhost:3000';
                    langfuseConfig.environment = res.environment || langfuseConfig.environment || 'dev';
                    langfuseConfig.release = res.release || '';
                    langfuseConfig.audit_payload_max_chars = Number(res.audit_payload_max_chars || langfuseConfig.audit_payload_max_chars || 24000);
                    return true;
                };
                const saveTenantSearchConfig = async () => {
                    const payload = {
                        word_w_sparse: Number(globalSearchConfig.word_w_sparse),
                        word_w_dense: Number(globalSearchConfig.word_w_dense),
                        sentence_w_sparse: Number(globalSearchConfig.sentence_w_sparse),
                        sentence_w_dense: Number(globalSearchConfig.sentence_w_dense),
                        top_n: Number(globalSearchConfig.top_n),
                        score_gap: Number(globalSearchConfig.score_gap),
                        relative_diff: Number(globalSearchConfig.relative_diff),
                        backfill_batch_size: Number(globalSearchConfig.backfill_batch_size),
                    };
                    const res = await call('PUT', '/api/v1/config/tenant-search-config', payload);
                    if (!res) return false;
                    globalSearchConfig.word_w_sparse = Number(res.word_w_sparse);
                    globalSearchConfig.word_w_dense = Number(res.word_w_dense);
                    globalSearchConfig.sentence_w_sparse = Number(res.sentence_w_sparse);
                    globalSearchConfig.sentence_w_dense = Number(res.sentence_w_dense);
                    globalSearchConfig.top_n = Number(res.top_n);
                    globalSearchConfig.score_gap = Number(res.score_gap);
                    globalSearchConfig.relative_diff = Number(res.relative_diff);
                    globalSearchConfig.backfill_batch_size = Number(res.backfill_batch_size);
                    return true;
                };
                const saveGlobalConfig = () => {
                    (async () => {
                    const wordWS = Number(globalSearchConfig.word_w_sparse);
                    const wordWD = Number(globalSearchConfig.word_w_dense);
                    const sentenceWS = Number(globalSearchConfig.sentence_w_sparse);
                    const sentenceWD = Number(globalSearchConfig.sentence_w_dense);
                    const topN = Math.max(1, Math.min(500, Math.floor(Number(globalSearchConfig.top_n) || 200)));
                    const scoreGap = Math.max(0, Number(globalSearchConfig.score_gap) || 0);
                    const relativeDiff = Math.max(0, Number(globalSearchConfig.relative_diff) || 0);
                    const isWordWeightValid = Number.isFinite(wordWS) && Number.isFinite(wordWD) && wordWS >= 0 && wordWD >= 0 && (wordWS + wordWD) > 0;
                    const isSentenceWeightValid = Number.isFinite(sentenceWS) && Number.isFinite(sentenceWD) && sentenceWS >= 0 && sentenceWD >= 0 && (sentenceWS + sentenceWD) > 0;
                    if (!isWordWeightValid || !isSentenceWeightValid) {
                        toast('Invalid weights, require non-negative and sum > 0 in both groups', 'error');
                        return;
                    }
                    globalSearchConfig.word_w_sparse = Number(wordWS.toFixed(4));
                    globalSearchConfig.word_w_dense = Number(wordWD.toFixed(4));
                    globalSearchConfig.sentence_w_sparse = Number(sentenceWS.toFixed(4));
                    globalSearchConfig.sentence_w_dense = Number(sentenceWD.toFixed(4));
                    globalSearchConfig.top_n = topN;
                    globalSearchConfig.score_gap = Number(scoreGap.toFixed(4));
                    globalSearchConfig.relative_diff = Number(relativeDiff.toFixed(4));
                    const searchSaved = await saveTenantSearchConfig();
                    if (!searchSaved) return;
                    const llmSaved = await saveTenantLlmConfig();
                    if (!llmSaved) return;
                    const langfuseSaved = await saveLangfuseConfig();
                    if (!langfuseSaved) return;
                    toast('Global config saved');
                    closeGlobalConfigModal();
                    runHybridSearch();
                    })();
                };
                const resetGlobalSearchWeights = () => {
                    globalSearchConfig.word_w_sparse = 0.45;
                    globalSearchConfig.word_w_dense = 0.55;
                    globalSearchConfig.sentence_w_sparse = 0.25;
                    globalSearchConfig.sentence_w_dense = 0.75;
                };
                const triggerEmbeddingBackfill = async () => {
                    const batchSize = Math.max(1, Math.min(5000, Number(globalSearchConfig.backfill_batch_size) || 200));
                    globalSearchConfig.backfill_batch_size = batchSize;
                    const res = await call('POST', '/api/v1/ontology/embeddings:backfill', {
                        resource_types: ['ontology', 'obj-prop', 'capability'],
                        batch_size: batchSize,
                    });
                    if (!res) return;
                    backfillResult.value = res;
                    toast(`Backfill updated ${res.updated_total} rows`);
                };

                const renderMd = (s) => s ? marked.parse(s) : '';
                const classNameById = (classId) => {
                    const cls = flatOntologies.value.find(item => item.id == classId);
                    return cls ? cls.name : `#${classId}`;
                };

                const fetchAll = async () => {
                    const [tree, attrs, rels, caps] = await Promise.all([
                        call('GET', '/api/v1/ontology/tree'),
                        call('GET', '/api/v1/ontology/data-attributes'),
                        call('GET', '/api/v1/ontology/object-properties'),
                        call('GET', '/api/v1/ontology/capabilities')
                    ]);
                    if (tree) {
                        ontologyTree.value = tree.items || [];
                        const flatten = (nodes) => nodes.reduce((acc, n) => { acc.push(n); if (n.children) acc.push(...flatten(n.children)); return acc; }, []);
                        flatOntologies.value = flatten(ontologyTree.value);
                    }
                    if (attrs) dataAttrs.value = attrs.items || [];
                    if (rels) objectProps.value = rels.items || [];
                    if (caps) capabilities.value = caps.items || [];
                };

                const selectItem = async (item) => {
                    selectedId.value = item.id;
                    let path = `/api/v1/ontology/${activeTab.value === 'ontology' ? 'classes' : (activeTab.value === 'data-attr' ? 'data-attributes' : (activeTab.value === 'obj-prop' ? 'object-properties' : 'capabilities'))}/${item.id}`;

                    const fullDetail = await call('GET', path);
                    if (!fullDetail) { selectedItem.value = item; return; }
                    
                    selectedItem.value = fullDetail;
                    Object.assign(editForm, {
                        name: fullDetail.name,
                        description: fullDetail.description || '',
                        data_type: fullDetail.data_type || 'string',
                        skill_md: fullDetail.skill_md || '',
                        directAttrIds: fullDetail.direct_attrs || [],
                        inheritedAttrIds: fullDetail.inherited_attrs || [],
                        domain_ids: fullDetail.domain_class_ids || [],
                        range_ids: fullDetail.range_class_ids || [],
                        cap_domain_groups: (fullDetail.domain_groups || []).map(group => [...group]),
                        table_name: fullDetail.table_binding?.table_name || '',
                        table_schema: fullDetail.table_binding?.table_schema || 'public',
                        field_mappings: (fullDetail.table_binding?.mappings || []).reduce((acc, m) => { acc[m.data_attribute_id] = m.field_name; return acc; }, {})
                    });
                };

                const saveChanges = async () => {
                    const id = selectedId.value;
                    const type = activeTab.value;
                    const payload = { name: editForm.name, description: editForm.description, status: 1 };
                    if (type === 'data-attr') payload.data_type = editForm.data_type;
                    if (type === 'obj-prop' || type === 'capability') payload.skill_md = editForm.skill_md;
                    if (type === 'obj-prop') { payload.domain_class_ids = editForm.domain_ids; payload.range_class_ids = editForm.range_ids; }
                    if (type === 'capability') payload.domain_groups = (editForm.cap_domain_groups || []).map(group => [...new Set((group || []).map(Number))]);

                    let path = `/api/v1/ontology/${type === 'ontology' ? 'classes' : (type === 'data-attr' ? 'data-attributes' : (type === 'obj-prop' ? 'object-properties' : 'capabilities'))}/${id}`;
                    
                    ideLog(`[IDE] Saving ${type} #${id}...`);
                    const res = await call('PUT', path, payload);
                    if (res) {
                        if (type === 'ontology') {
                            const normalizedDirectAttrIds = [...new Set((editForm.directAttrIds || []).map(v => Number(v)).filter(Number.isInteger))];
                            ideLog(`[IDE] Binding attributes to class #${id}:`, editForm.directAttrIds);
                            const bindRes = await call('POST', `/api/v1/ontology/classes/${id}/data-attributes:bind`, { data_attribute_ids: normalizedDirectAttrIds });
                            if (!bindRes) return;
                            editForm.directAttrIds = normalizedDirectAttrIds;
                            
                            if (editForm.table_name) {
                                ideLog(`[IDE] Saving table binding for class #${id}...`);
                                const tableBindingRes = await call('PUT', `/api/v1/ontology/classes/${id}/table-binding`, { table_name: editForm.table_name, table_schema: editForm.table_schema });
                                if (!tableBindingRes) return;
                                const boundIds = [...new Set([...editForm.directAttrIds, ...editForm.inheritedAttrIds])];
                                const mappings = Object.entries(editForm.field_mappings).filter(([attrId, field]) => field && boundIds.includes(Number(attrId))).map(([attrId, field]) => ({ data_attribute_id: Number(attrId), field_name: field }));
                                if (mappings.length > 0) {
                                    ideLog(`[IDE] Saving field mappings for class #${id}...`);
                                    const fieldMappingRes = await call('PUT', `/api/v1/ontology/classes/${id}/table-binding/field-mapping`, { mappings });
                                    if (!fieldMappingRes) return;
                                }
                            }
                        }
                        toast('Saved successfully');
                        await fetchAll();
                        // Refresh selection to show new bound state
                        const list = type === 'ontology' ? flatOntologies.value : (type === 'data-attr' ? dataAttrs.value : (type === 'obj-prop' ? objectProps.value : capabilities.value));
                        const item = list.find(i => i.id == id);
                        if (item) await selectItem(item);
                    }
                };

                const createPhysicalTable = async () => {
                    if (activeTab.value !== 'ontology' || !selectedId.value) return;
                    const res = await call('POST', `/api/v1/ontology/classes/${selectedId.value}/table-binding:create-table`);
                    if (!res) return;
                    toast(`Table created: ${res.table_name}`);
                    await fetchAll();
                    const refreshed = flatOntologies.value.find(item => item.id == selectedId.value);
                    if (refreshed) await selectItem(refreshed);
                };

                const openManageDataModal = async () => {
                    if (activeTab.value !== 'ontology' || !selectedId.value || !editForm.table_name) return;
                    manageData.page = 1;
                    manageData.total = 0;
                    manageData.items = [];
                    manageData.columns = [];
                    manageData.filter_field = '';
                    manageData.filter_op = 'eq';
                    manageData.filter_value = '';
                    manageData.sort_field = '';
                    manageData.sort_order = 'asc';
                    manageData.new_row = {};
                    manageData.edit_row = {};
                    manageData.editing_row_token = '';
                    document.getElementById('manage_data_modal').showModal();
                    await queryManageData(1);
                };
                const closeManageDataModal = () => document.getElementById('manage_data_modal').close();

                const queryManageData = async (page = 1) => {
                    if (!selectedId.value) return;
                    const filters = [];
                    if (manageData.filter_field && manageData.filter_value !== '') {
                        filters.push({
                            field: manageData.filter_field,
                            op: manageData.filter_op,
                            value: manageData.filter_op === 'in' ? manageData.filter_value.split(',').map(v => v.trim()).filter(Boolean) : manageData.filter_value
                        });
                    }
                    const payload = {
                        page: Math.max(1, page),
                        page_size: manageData.page_size,
                        filters,
                        sort_field: manageData.sort_field || null,
                        sort_order: manageData.sort_order
                    };
                    const res = await call('POST', `/api/v1/ontology/classes/${selectedId.value}/table-binding:data:query`, payload);
                    if (!res) return;
                    manageData.page = res.page;
                    manageData.page_size = res.page_size;
                    manageData.total = res.total;
                    manageData.columns = res.columns || [];
                    manageData.items = res.items || [];
                    if (!manageData.sort_field && manageData.columns.length > 0) manageData.sort_field = manageData.columns[0].field_name;
                };

                const createManageDataRow = async () => {
                    if (!selectedId.value || (manageData.columns || []).length === 0) return;
                    const values = {};
                    try {
                        for (const col of manageData.columns) {
                            if (!(col.field_name in manageData.new_row)) continue;
                            values[col.field_name] = parseInputValueByType(manageData.new_row[col.field_name], col.data_type);
                        }
                    } catch (e) {
                        return toast(`Invalid input: ${e.message}`, 'error');
                    }
                    const res = await call('POST', `/api/v1/ontology/classes/${selectedId.value}/table-binding:data`, { values });
                    if (!res) return;
                    manageData.new_row = {};
                    toast('Row added');
                    await queryManageData(manageData.page);
                };

                const startEditDataRow = (row) => {
                    manageData.editing_row_token = row.__row_token;
                    manageData.edit_row = {};
                    for (const col of manageData.columns) {
                        const value = row[col.field_name];
                        manageData.edit_row[col.field_name] = typeof value === 'object' && value !== null ? JSON.stringify(value) : (value ?? '');
                    }
                };
                const cancelEditDataRow = () => {
                    manageData.editing_row_token = '';
                    manageData.edit_row = {};
                };
                const saveEditDataRow = async () => {
                    if (!selectedId.value || !manageData.editing_row_token) return;
                    const values = {};
                    try {
                        for (const col of manageData.columns) {
                            if (!(col.field_name in manageData.edit_row)) continue;
                            values[col.field_name] = parseInputValueByType(manageData.edit_row[col.field_name], col.data_type);
                        }
                    } catch (e) {
                        return toast(`Invalid input: ${e.message}`, 'error');
                    }
                    const res = await call('PUT', `/api/v1/ontology/classes/${selectedId.value}/table-binding:data/${encodeURIComponent(manageData.editing_row_token)}`, { values });
                    if (!res) return;
                    toast('Row updated');
                    cancelEditDataRow();
                    await queryManageData(manageData.page);
                };

                const deleteSelected = async () => {
                    const id = selectedId.value;
                    const type = activeTab.value;
                    if (!id) return;
                    const typeName = type === 'ontology' ? 'ontology' : (type === 'data-attr' ? 'data attribute' : (type === 'obj-prop' ? 'object property' : 'capability'));
                    if (!window.confirm(`Delete this ${typeName}? This action cannot be undone.`)) return;
                    if (type === 'ontology') {
                        const confirmInput = window.prompt('二次确认：该操作将物理删除本体及其绑定关系。请输入 DELETE 继续。', '');
                        if (confirmInput !== 'DELETE') {
                            toast('已取消删除：二次确认未通过', 'error');
                            return;
                        }
                    }

                    const path = `/api/v1/ontology/${type === 'ontology' ? 'classes' : (type === 'data-attr' ? 'data-attributes' : (type === 'obj-prop' ? 'object-properties' : 'capabilities'))}/${id}`;
                    const res = await call('DELETE', path);
                    if (!res) return;

                    toast('Deleted successfully');
                    selectedId.value = null;
                    selectedItem.value = null;
                    await fetchAll();
                };

                const navigateTo = (tab, id) => {
                    activeTab.value = tab;
                    setTimeout(async () => {
                        const list = tab === 'ontology' ? flatOntologies.value : (tab === 'data-attr' ? dataAttrs.value : (tab === 'obj-prop' ? objectProps.value : capabilities.value));
                        const item = list.find(i => i.id == id);
                        if (item) selectItem(item);
                    }, 100);
                };

                const openCreateModal = (parent = null) => {
                    Object.assign(createForm, {
                        code: '', name: '', description: '', parentCode: parent ? parent.code : '', data_type: 'string',
                        skill_md: '', domain_ids: [], range_ids: [], cap_domain_groups: []
                    });
                    document.getElementById('create_modal').showModal();
                };
                const closeCreateModal = () => document.getElementById('create_modal').close();

                const executeCreate = async () => {
                    const type = activeTab.value;
                    let path = `/api/v1/ontology/${type === 'ontology' ? 'classes' : (type === 'data-attr' ? 'data-attributes' : (type === 'obj-prop' ? 'object-properties' : 'capabilities'))}`;
                    const payload = { code: createForm.code, name: createForm.name, description: createForm.description };
                    if (type === 'data-attr') payload.data_type = createForm.data_type;
                    if (type === 'obj-prop' || type === 'capability') payload.skill_md = createForm.skill_md;
                    if (type === 'obj-prop') {
                        payload.domain_class_ids = [...new Set((createForm.domain_ids || []).map(Number))];
                        payload.range_class_ids = [...new Set((createForm.range_ids || []).map(Number))];
                        if (payload.domain_class_ids.length === 0 || payload.range_class_ids.length === 0) {
                            return toast('Object Property 必须配置 domain 和 range', 'error');
                        }
                    }
                    if (type === 'capability') {
                        payload.input_schema = { type: 'object', properties: {} };
                        payload.output_schema = { type: 'object', properties: {} };
                        payload.domain_groups = (createForm.cap_domain_groups || []).map(group => [...new Set((group || []).map(Number))]).filter(group => group.length > 0);
                    }

                    const res = await call('POST', path, payload);
                    if (res) {
                        if (type === 'ontology' && createForm.parentCode) {
                            const parent = flatOntologies.value.find(o => o.code === createForm.parentCode);
                            if (parent) await call('POST', `/api/v1/ontology/classes/${res.id}/inheritance`, { parent_class_id: parent.id });
                        }
                        toast('Created successfully');
                        closeCreateModal();
                        fetchAll();
                    }
                };

                const openAttrPicker = () => {
                    tempDirectAttrIds.value = [...editForm.directAttrIds];
                    document.getElementById('attr_picker_modal').showModal();
                };
                const closeAttrPicker = () => document.getElementById('attr_picker_modal').close();
                const confirmAttrPicker = () => {
                    editForm.directAttrIds = [...new Set((tempDirectAttrIds.value || []).map(v => Number(v)).filter(Number.isInteger))];
                    closeAttrPicker();
                };
                const removeDirectAttr = (id) => {
                    editForm.directAttrIds = editForm.directAttrIds.filter(bid => bid !== id);
                };

                const openClassPicker = (target) => {
                    classPickerTarget.value = target;
                    classPickerTitle.value = target.includes('range') ? '选择 Range 本体' : '选择 Domain 本体';
                    if (target === 'obj-domain') classPickerSelection.value = [...(editForm.domain_ids || [])];
                    else if (target === 'obj-range') classPickerSelection.value = [...(editForm.range_ids || [])];
                    else if (target === 'create-obj-domain') classPickerSelection.value = [...(createForm.domain_ids || [])];
                    else if (target === 'create-obj-range') classPickerSelection.value = [...(createForm.range_ids || [])];
                    document.getElementById('class_picker_modal').showModal();
                };
                const closeClassPicker = () => document.getElementById('class_picker_modal').close();
                const confirmClassPicker = () => {
                    const normalized = [...new Set((classPickerSelection.value || []).map(Number).filter(Number.isInteger))];
                    if (classPickerTarget.value === 'obj-domain') editForm.domain_ids = normalized;
                    else if (classPickerTarget.value === 'obj-range') editForm.range_ids = normalized;
                    else if (classPickerTarget.value === 'create-obj-domain') createForm.domain_ids = normalized;
                    else if (classPickerTarget.value === 'create-obj-range') createForm.range_ids = normalized;
                    closeClassPicker();
                };

                const openCapabilityDomainGroupModal = (forCreate = false) => {
                    capDomainForCreate.value = forCreate;
                    tempCapDomainGroups.value = ((forCreate ? createForm.cap_domain_groups : editForm.cap_domain_groups) || []).map(group => [...group]);
                    activeTempGroupIndex.value = tempCapDomainGroups.value.length > 0 ? 0 : -1;
                    document.getElementById('cap_domain_group_modal').showModal();
                };
                const closeCapabilityDomainGroupModal = () => document.getElementById('cap_domain_group_modal').close();
                const addTempCapabilityGroup = () => {
                    tempCapDomainGroups.value.push([]);
                    activeTempGroupIndex.value = tempCapDomainGroups.value.length - 1;
                };
                const removeTempCapabilityGroup = () => {
                    if (activeTempGroupIndex.value < 0 || tempCapDomainGroups.value.length === 0) return;
                    tempCapDomainGroups.value.splice(activeTempGroupIndex.value, 1);
                    if (tempCapDomainGroups.value.length === 0) activeTempGroupIndex.value = -1;
                    else if (activeTempGroupIndex.value >= tempCapDomainGroups.value.length) activeTempGroupIndex.value = tempCapDomainGroups.value.length - 1;
                };
                const confirmCapabilityDomainGroupModal = () => {
                    const normalized = tempCapDomainGroups.value
                        .map(group => [...new Set((group || []).map(Number).filter(Number.isInteger))])
                        .filter(group => group.length > 0);
                    if (capDomainForCreate.value) createForm.cap_domain_groups = normalized;
                    else editForm.cap_domain_groups = normalized;
                    closeCapabilityDomainGroupModal();
                };

                const openDetailPreview = async (tab, id) => {
                    const path = `/api/v1/ontology/${tab === 'ontology' ? 'classes' : (tab === 'data-attr' ? 'data-attributes' : (tab === 'obj-prop' ? 'object-properties' : 'capabilities'))}/${id}`;
                    const detail = await call('GET', path);
                    if (!detail) return;
                    previewModal.tab = tab;
                    previewModal.id = id;
                    previewModal.title = tab === 'data-attr' ? 'Data Attribute Detail' : (tab === 'obj-prop' ? 'Object Property Detail' : 'Capability Detail');
                    previewModal.code = detail.code || '';
                    previewModal.name = detail.name || '';
                    previewModal.description = detail.description || '';
                    document.getElementById('detail_preview_modal').showModal();
                };
                const closeDetailPreview = () => document.getElementById('detail_preview_modal').close();
                const openPreviewInEditor = () => {
                    closeDetailPreview();
                    if (!previewModal.tab || !previewModal.id) return;
                    navigateTo(previewModal.tab, previewModal.id);
                };

                const onGlobalKeydown = (event) => {
                    if (!(event.ctrlKey || event.metaKey) || event.key.toLowerCase() !== 's') return;
                    if (!selectedItem.value) return;
                    event.preventDefault();
                    saveChanges();
                };

                const changeTab = (tid) => { activeTab.value = tid; selectedId.value = null; selectedItem.value = null; };
                const owlValidate = () => call('POST', '/api/v1/ontology/owl:validate', { strict: true });
                const owlExport = () => window.open(`/api/v1/ontology/owl:export?format=ttl&Authorization=${config.token}`, '_blank');

                onMounted(() => {
                    applyTheme(theme.value);
                    fetchAll();
                    window.addEventListener('keydown', onGlobalKeydown);
                });
                onBeforeUnmount(() => {
                    window.removeEventListener('keydown', onGlobalKeydown);
                });
                watch(config, () => { localStorage.setItem('tenantId', config.tenantId); localStorage.setItem('token', config.token); });

                return {
                    tabs, activeTab, activeConfigTab, currentTabName, currentTabIcon, changeTab,
                    ontologyTree, flatOntologies, dataAttrs, objectProps, capabilities,
                    selectedId, selectedItem, editForm, createForm, manageData,
                    searchQuery, attrSearchQuery, filteredTree, filteredOntologyList, showOntologySearchResultList, filteredList, filteredAllAttrs, flatClassTreeWithDepth,
                    boundAttributesList, boundOntologies, selectedItemRelations, selectedItemCapabilities, selectedDomainClasses, selectedRangeClasses,
                    loading, showLogs, logs, toasts, tempDirectAttrIds, classPickerTitle, classPickerSelection, tempCapDomainGroups, activeTempGroupIndex, previewModal,
                    renderMd, selectItem, saveChanges, createPhysicalTable, openManageDataModal, closeManageDataModal, queryManageData, createManageDataRow, startEditDataRow, cancelEditDataRow, saveEditDataRow, navigateTo, classNameById, formatDataCell,
                    executeSearch,
                    deleteSelected,
                    openCreateModal, closeCreateModal, executeCreate,
                    openAttrPicker, closeAttrPicker, confirmAttrPicker, removeDirectAttr,
                    openClassPicker, closeClassPicker, confirmClassPicker,
                    openCapabilityDomainGroupModal, closeCapabilityDomainGroupModal, addTempCapabilityGroup, removeTempCapabilityGroup, confirmCapabilityDomainGroupModal,
                    openDetailPreview, closeDetailPreview, openPreviewInEditor,
                    owlValidate, owlExport, config,
                    isDarkTheme, toggleTheme, openGraphWorkspace,
                    globalSearchConfig, openGlobalConfigModal, closeGlobalConfigModal, saveGlobalConfig,
                    resetGlobalSearchWeights, effectiveWeightRatioWord, effectiveWeightRatioSentence, triggerEmbeddingBackfill, backfillResult,
                    tenantLlmConfig, verifyTenantLlmConfig, tenantLlmVerifyResult,
                    langfuseConfig,
                    handlePrimaryProviderChange, handleFallbackProviderChange
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
