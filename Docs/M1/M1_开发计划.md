# M1开发计划

## 1. 目标与范围
- 阶段目标：完成 M1 的后端系统、检索能力、元数据 MCP 接口、基础鉴权租户隔离、可访问页面（含录入管理台）与测试用例。
- In Scope：本体管理、知识框架、4 个元数据 MCP API、Hybrid Search、录入管理页面与配套查询接口。
- Out of Scope：M2+ 的多会话编排、复杂递归执行、数据虚拟化执行链路、推理链路画布。

## 2. 开发步骤（可执行、可验证）

| 步骤ID | 步骤名称 | 交付物 | 验证方式 | 状态 |
|---|---|---|---|---|
| S1 | 需求梳理与方案冻结 | M1范围矩阵、字段与接口清单 | 文档对照检查（需求清单 + 概要设计 + M1文档） | 已完成 |
| S2 | 工程脚手架初始化 | `src/app`、`tests`、`requirements.txt`、`README.md` | 目录结构与入口文件存在性检查 | 已完成 |
| S3 | 数据模型与持久化层 | SQLAlchemy 模型、DB Session、仓储层 | 单测：模型创建、基础 CRUD | 已完成 |
| S4 | Ontology 领域能力 | class/attribute/relation/capability/binding/inheritance API 与服务 | 单测：继承环检测、schema 校验、逻辑删除 | 已完成 |
| S5 | Knowledge 领域能力 | class/attribute/template/fewshot API 与服务 | 单测：版本递增、查询最新版本 | 已完成 |
| S6 | Hybrid Search 引擎 | query preprocess、sparse+dense 融合评分 | 单测：融合打分、排序稳定性 | 已完成 |
| S7 | MCP Metadata 4接口 | attributes:match、ontologies:by-attributes、ontology detail、execution detail | 集成测：四接口 happy path + 边界场景 | 已完成 |
| S8 | 中间件与通用能力 | trace_id、响应封装、统一异常、X-Tenant-Id + JWT基础校验 | 接口测试：错误码与 trace_id 一致性 | 已完成 |
| S9 | 可访问页面 | 首页 `/`（系统状态、接口导航、M1能力说明） | 浏览器访问返回 200 且内容可读 | 已完成 |
| S12 | 本体与知识录入管理台 | 页面 `/m1/console`；Class 列表 API；Knowledge 最新版本查询 API | 集成测：页面可访问，Class 列表与知识查询可用 | 已完成 |
| S10 | 联调与验收测试 | 单测+集成测、覆盖关键验收点 | `pytest` 全量通过 | 已完成 |
| S11 | 文档与进度回填 | README、计划状态更新、已知限制说明 | 文档完整性检查 | 已完成 |

## 3. 关键验收映射
- 本体管理：S4
- 知识框架：S5
- 系统级元数据 MCP：S7
- Hybrid Search：S6
- 租户隔离/基础鉴权/trace：S8
- 可访问页面：S9
- 录入管理台：S12
- 测试与可验证交付：S10

## 4. 开发过程进度记录
- 2026-02-13：完成 S1，已读取并对齐 `Docs/TheWorld需求清单.md`、`Docs/Project_TheWorld_概要设计文档.md`、`Docs/M1/*` 全部文档。
- 2026-02-13：完成 S2-S3，落地 `src/app` 工程骨架、SQLAlchemy 模型与仓储层。
- 2026-02-13：完成 S4-S5，实现 Ontology/Knowledge 全量 M1 API 与服务。
- 2026-02-13：完成 S6-S9，实现 Hybrid 检索引擎、4 个 MCP Metadata 接口、trace/error/auth 基础能力与首页 `/`。
- 2026-02-13：完成 S10，执行 `python -m pytest -q`，结果 `6 passed`。
- 2026-02-13：完成 S11，README 与计划状态回填完毕。
- 2026-02-15：完成 S12，新增 `/m1/console` 录入管理页面，补充 Class 列表与 Knowledge 最新版本查询接口，并通过集成测试。

## 5. 风险与应对
- 风险：本地缺少 PostgreSQL/pgvector 环境导致开发验证阻塞。
- 应对：统一使用 PostgreSQL 环境进行开发和测试，确保与部署环境一致。

## 6. 执行命令（计划）
- 安装依赖：`pip install -r requirements.txt`
- 运行服务：`uvicorn src.app.main:app --reload`
- 运行测试：`pytest -q`

## 7. 需求 1.3/1.6 对齐计划增补（优先级覆盖前文冲突）

说明：如与前文冲突，以本节为准。

1. 新增阶段任务
| 步骤ID | 步骤名称 | 交付物 | 验证方式 | 状态 |
|---|---|---|---|---|
| S13 | OWL 元模型对齐 | OWL 对齐数据模型、校验规则、导出接口定义 | 用例：可导出 RDF/XML 或 TTL 且可被 RDF4J 解析 | 待开始 |
| S14 | 全局目录与引用重构 | 数据属性/对象属性/能力全量管理方案与本体引用关系 | 用例：全局 CRUD + 本体绑定闭环 | 待开始 |
| S15 | 本体关联表约束强化 | 一本体一关联表 + 字段映射配置设计 | 用例：冲突约束与映射校验通过 | 待开始 |
| S16 | 知识框架结构化升级 | intent/few-shot/schema/skill.md 字段与录入规范 | 用例：关系/能力详情接口返回可执行知识结构 | 待开始 |
| S17 | 2.1/2.2 适配验收 | 元数据查询与推理引导链路验收清单 | 场景：属性->本体->执行细节->任务递归闭环 | 待开始 |

2. 对 2.1/2.2 的当前评估结论
- 当前文档版本在“全局属性目录、对象属性 domain/range、多源能力知识结构化”方面存在缺口。
- 引入 S13-S17 后，M1 设计可为 2.1/2.2 提供可执行且可验证的基础能力。
