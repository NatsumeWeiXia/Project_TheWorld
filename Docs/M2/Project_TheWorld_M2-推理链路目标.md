# 推理链路目标  

----

## 整体工作方式：

本系统为基于本体的AI操作系统，LLM需要遵循以下逻辑进行推理，直到完成用户意图或发现无法进行给出提示。

1. LLM需要首先理解用户的意图，对用户意图进行拆解，提取出其中的关键业务概念，并大概构思出任务完成步骤，明确用户提供的信息和最终要达成的目标。

2. 引导LLM根据用户意图、上一步提取的关键业务概念、任务完成步骤，结合tools：

   graph.list_data_attributes：对数据属性进行Hybrid Search。

   graph.list_ontologies：对本体进行Hybrid Search。

   graph.get_data_attribute_related_ontologies：根据数据属性查询本体。
   
   定位到和用户意图符合的起点本体和目标本体（可以没有），如果无法定位起点本体则给出反馈，让用户补充更多信息。

3. 引导LLM基于上一步定位到的本体，结合tools：

   graph.get_ontology_details：获取本体的详细介绍，包括其数据属性、和其他本体的关系、可以执行的能力。

   graph.get_object_property_details：获取本体到本体的关系，确定如何从一个本体获取另一个本体。

   graph.get_capability_details：获取本体具有的能力，确定如何触发并执行这个能力。

   选择符合用户意图的能力，实现用户的意图，并根据能力返回的内容总结输出。如果没有符合用户意图的能力，则根据关系查看可以从此本体到达的其他本体，进而查询该本体下的能力，寻找能够实现该意图的能力，如果没找到则继续遍历从该本体可继续根据关系到达的本体，每当需要遍历下一个本体时，需要给用户反馈，让用户确认后再进行，直到完成用户的任务或者用户取消任务。

重点：

1. 用户意图的识别很重要，需要深入分析用户输入进行理解。
2. 本体的定位很关键，起点本体定位准确与否直接决定推理质量。
3. 本体遍历推理要严格控制遍历深度，控制在最小必要范围内。

## 样例：

### 例1（简单版）：

**用户输入：**

“对手机号为15191445006的人进行综合分析”

**期望LLM提取出关键业务概念：**

手机号、人、综合分析。

**期望LLM给出处理路径：**

首先通过手机号找到人，再对人进行综合分析。

tasks：

1. 我需要找到本体可以满足由手机号定位到人。
2. 我要找到可以对人进行综合分析的本体及能力。

**期望LLM给出关键业务概念：**

要素：手机号，值：15191445006；

要素：人；

目标动作：综合分析。

**系统调用多次 graph.list_data_attributes：**

**

入参分别为：手机号、人 及其他提取出的要素。

返回结果分别为数据属性：手机号、人员ID、身份证号 等。

**系统将前面的多次结果汇总，调用一次 graph.get_data_attribute_related_ontologies：**

入参为：手机号，人员ID，身份证号。

返回结果为本体：自然人、行为、终端设备、出行行为等。

**系统调用一次 graph.list_ontologies：**

入参为用户原始输入：“对手机号为15191445006的人进行综合分析”

返回结果为本体：教师、自然人、行为、客体等。

**系统再调用一次 graph.list_ontologies：**

入参为：手机号，人员ID，身份证号。

返回结果为本体：自然人、教师件、组织等。

**系统将所有的返回本体进行汇总去重，提交给LLM，由LLM根据用户意图最终选定哪些本体是用户的“输入本体”，哪些本体是“目标本体（可为空）”:**

LLM选定输入本体为：自然人，无目标本体。

**LLM触发系统调用 graph.get_ontology_details：**

入参为：自然人。

获取到自然人本体的详情，包括其描述、包含的数据属性、对象属性、能力。

LLM对信息进行综合分析，发现自然人下有一个能力叫综合分析还有一个能力叫条件查询。

**LLM触发系统调用 graph.get_capability_details：**

入参分别为：条件查询、综合分析

获取到条件查询的执行条件，根据15191445006生成入参，查询到15191445006关联的自然人。

获取到综合分析下的实际执行步骤，根据查询到的自然人，结合根据步骤完成分析并返回结果给用户。

### 例2（复杂版）：

**用户输入：**

“向最近三天出现在天坛周围的手机里装有微信的人发送短信，短信内容为“欢迎来到天坛””

**期望LLM提取出关键业务概念：**

时间（最近三天）、地点（天坛周围）、设备/应用（手机、微信）、人、动作（发送短信）、内容（“欢迎来到天坛”）。

**期望LLM给出处理路径：**

首先，根据时间和地点（最近三天、天坛周围）找到在此区域出现过的手机（终端设备记录）。

其次，在这些手机中筛选出安装了“微信”APP的设备。

然后，通过这些终端设备找到其归属的“人”及对应的手机号码。

最后，调用发送短信的能力，向这些手机号发送内容为“欢迎来到天坛”的短信。

tasks：

1. 我需要找到可以通过时间、地点查询轨迹记录的本体，从而定位到特定的终端设备。
2. 我需要找到能够查询终端设备已安装应用（微信）的本体及能力/关系。
3. 我需要找到能将终端设备关联到自然人（或直接获取手机号）的本体及关系。
4. 我需要找到具备发送短信能力的本体及能力。

**期望LLM给出关键业务概念：**

要素：时间，值：最近三天；

要素：地点，值：天坛周围；

要素：应用，值：微信；

要素：人/终端设备；

目标动作：发送短信，值：“欢迎来到天坛”。

**系统调用多次 `graph.list_data_attributes`：**

入参分别为：时间、地点、应用、人、手机、短信。

返回结果预期为数据属性：出现时间、位置坐标/区域名称、应用名称/APPID、人员ID、设备标识码（MAC/IMEI）、手机号码等。

**系统将前面的多次结果汇总，调用一次 `graph.get_data_attribute_related_ontologies`：**

入参为：出现时间、位置坐标、应用名称、设备标识码、手机号码。

返回结果预期为本体：位置轨迹、终端设备、自然人、应用软件、消息服务等。

**系统调用一次 `graph.list_ontologies`：**

入参为用户原始输入：“向最近三天出现在天坛周围的手机里装有微信的人发送短信，短信内容为“欢迎来到天坛””

返回结果预期为本体：轨迹记录、终端设备、自然人、通信能力等。

**系统再调用一次 `graph.list_ontologies`：**

入参为：时间、地点、微信、人、手机、短信。

返回结果预期为本体：位置轨迹、终端设备、自然人、应用软件、消息服务等。

**系统将所有的返回本体进行汇总去重，提交给LLM，由LLM根据用户意图最终选定哪些本体是用户的“输入本体”，哪些本体是“目标本体”：**

LLM选定**输入本体**为：位置轨迹（或终端设备）、应用软件。

LLM选定**目标本体**为：自然人（需获取手机号作为最终目标对象），以及包含发送能力的本体（如自然人或消息服务）。

**LLM触发系统调用 `graph.get_ontology_details`（第1步：空间与时间定位）：**

入参为：位置轨迹。

获取到“位置轨迹”本体的详情，发现其具备条件查询能力或存在关联到“终端设备”的关系。

LLM发现这需要跨越本体（从“位置轨迹”到“终端设备”，再到“应用软件”和“自然人”），根据**“每当需要遍历下一个本体时，需要给用户反馈”**的原则，LLM触发交互：

*“为了完成您的任务，我需要先查询最近三天在天坛周围出现过的设备记录，然后检查这些设备是否安装了微信，最后找到设备机主发送短信。是否允许我开始执行第一步查询？”*

（假设用户确认“继续”）

**LLM触发系统调用 `graph.get_capability_details`（筛选设备）：**

入参为：位置轨迹的条件查询。

根据“最近三天”和“天坛周围”生成入参，查询到一批在此区域出现过的终端设备列表。

**LLM触发系统调用 `graph.get_object_property_details`（第2步：跨本体寻找应用和人）：**

入参为：终端设备。

获取“终端设备”到其他本体的关系。发现存在 `终端设备 -> 应用软件`（包含关系）以及 `终端设备 -> 自然人`（归属关系）。

**LLM触发系统调用 `graph.get_capability_details`（交叉过滤与定位人）：**

查询并过滤出上述设备列表中，其关联的“应用软件”包含“微信”的终端设备。

通过 `终端设备 -> 自然人` 的关系，获取到这批设备对应的“自然人”实体及他们的数据属性“手机号码”。

**LLM触发系统调用 `graph.get_ontology_details` 及 `graph.get_capability_details`（第3步：执行目标动作）：**

入参为：自然人（或关联的消息服务本体）。

发现本体下具备“发送短信”的能力。

获取执行条件，将上一步筛选出的“手机号码列表”和用户指定的短信内容“欢迎来到天坛”作为入参组合。

*（可选环节：LLM向用户进行最后确认：“已为您筛选出符合条件的X人，即将发送内容为‘欢迎来到天坛’的短信，是否确认发送？”）*

用户确认后，调用“发送短信”能力执行动作。

**最终反馈：**

LLM根据能力返回的内容总结输出（例如：“任务已完成，已成功向最近三天在天坛周围出现且手机装有微信的XX位人员发送了短信‘欢迎来到天坛’。”）。